<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Chris Zuidema for ENVH 556 Autumn 2024">

<title>Week 3 Lab Companion: Regression for Association</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Week3LabCompanion_files/libs/clipboard/clipboard.min.js"></script>
<script src="Week3LabCompanion_files/libs/quarto-html/quarto.js"></script>
<script src="Week3LabCompanion_files/libs/quarto-html/popper.min.js"></script>
<script src="Week3LabCompanion_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Week3LabCompanion_files/libs/quarto-html/anchor.min.js"></script>
<link href="Week3LabCompanion_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Week3LabCompanion_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Week3LabCompanion_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Week3LabCompanion_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Week3LabCompanion_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 3 Lab Companion: Regression for Association</h1>
<p class="subtitle lead">Companion document with more advanced coding methods</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Chris Zuidema for ENVH 556 Autumn 2024 </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>This document was rendered on September 25, 2024.</p>
<section id="purpose" class="level1">
<h1>Purpose</h1>
<p>This document is a companion to the <code>Week3Lab.Rmd</code>. The purpose is to provide additional and somewhat more sophisticated coding methods to supplement the approaches demonstrated in Lab 3; you may find these more advanced coding methods useful for your own work. Our coding goals for <code>Week3Lab.Rmd</code> were clarity and transparency to support learning about regression. Here we demonstrate some techniques that will scale well (for example to many regression models), reduce code repetition, and reduce the amount of “hard coding” in the analysis, but that are less explicit and may obscure what is going on “behind the scenes” a bit. As with <code>Week3Lab.Rmd</code>, this document will use the snapshot data.</p>
</section>
<section id="preliminaries" class="level1">
<h1>Preliminaries</h1>
<p>These preliminary steps are the same as <code>Week3Lab.Rmd</code> and are included for completeness.</p>
<section id="prepare-snapshot-dataframe" class="level2">
<h2 class="anchored" data-anchor-id="prepare-snapshot-dataframe">Prepare snapshot dataframe</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----prep snapshot-----</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># transform snapshot dataframe to tibble and modify season factor</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>snapshot <span class="ot">&lt;-</span> snapshot <span class="sc">%&gt;%</span> </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">seasonfac =</span> <span class="fu">factor</span>(<span class="fu">str_remove</span>(seasonfac, <span class="st">"[:digit:]"</span>),   </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Summer"</span>, <span class="st">"Fall"</span>, <span class="st">"Winter"</span>)) )</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># create season variable (to be used throughout analysis)</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>seasons <span class="ot">&lt;-</span> <span class="fu">unique</span>(snapshot<span class="sc">$</span>seasonfac)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="summarize-ln_nox-by-season" class="level2">
<h2 class="anchored" data-anchor-id="summarize-ln_nox-by-season">Summarize <em>ln_nox</em> by season</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----summarize ln_nox-----</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># frequencies only</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(snapshot<span class="sc">$</span>seasonfac)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Summer   Fall Winter 
   148    152    149 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># descriptive statistics</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>snapshot_summary <span class="ot">&lt;-</span> snapshot <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(seasonfac) <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">Mean =</span> <span class="fu">mean</span>(ln_nox), </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">SD =</span> <span class="fu">sd</span>(ln_nox),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">GM =</span> <span class="fu">exp</span>(<span class="fu">mean</span>(ln_nox)), </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">GSD =</span> <span class="fu">exp</span>(<span class="fu">sd</span>(ln_nox)), </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># show summary</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>snapshot_summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  seasonfac     N  Mean    SD    GM   GSD
  &lt;fct&gt;     &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 Summer      148  3.47  0.39  32.1  1.47
2 Fall        152  4.27  0.32  71.5  1.37
3 Winter      149  4.51  0.3   91.3  1.35</code></pre>
</div>
</div>
</section>
<section id="season-specific-boxplots" class="level2">
<h2 class="anchored" data-anchor-id="season-specific-boxplots">Season-specific boxplots</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----season-specific boxplots-----</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(snapshot, <span class="fu">aes</span>(<span class="at">x =</span> seasonfac, <span class="at">y =</span> ln_nox, <span class="at">fill =</span> seasonfac)) <span class="sc">+</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Season"</span>, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"ln(NOx) (ln(ppb)"</span>, </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Season"</span>, </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">fill =</span> <span class="st">"Season"</span>) <span class="sc">+</span> </span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_article</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Week3LabCompanion_files/figure-html/season-specific%20boxplots-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="regression-analysis" class="level1">
<h1>Regression analysis</h1>
<p><code>Week3Lab.Rmd</code> takes a more manual approach to regression modeling by specifying each of the seasonal models separately and assigning each model fit to its own object. This approach is clear and easy to follow, but you can see how this would quickly become a burdensome exercise potentially fraught with errors due to its reliance on copy/paste and repeated code. Imagine if we had 20 seasons instead of 3. In this section, we explore the general nesting workflow, where data is grouped and modeling steps occur “within” a dataframe. Aside from managing analysis steps with groups programmatically, these functions package regression output in dataframes that are <code>ggplot</code> friendly, thus minimizing the data wrangling required before plotting.</p>
<p>You can find more information about the nested workflow here:</p>
<ul>
<li>Tidyverse <a href="https://tidyr.tidyverse.org/articles/nest.html">“Nested Data”</a></li>
<li>Bookdown <a href="https://r4ds.had.co.nz/many-models.html">“Many Models”</a></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----regression for association-----</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Common model (Table 4), season-specific LUR from Mercer et al, 2011</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># specify the "common model"</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>frml <span class="ot">&lt;-</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>(ln_nox <span class="sc">~</span> D2A1 <span class="sc">+</span> A1_50 <span class="sc">+</span> A23_400 <span class="sc">+</span> Pop_5000 <span class="sc">+</span> D2C <span class="sc">+</span> Int_3000 <span class="sc">+</span> D2Comm)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># create tibble with nested seasonal models</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>season_mods_nested <span class="ot">&lt;-</span> snapshot <span class="sc">%&gt;%</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># group by season, then "nest"</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(seasonfac) <span class="sc">%&gt;%</span> </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fit regression model for each season and generate summary, glance, augment,</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and in-sample prediction outputs with prediction intervals.</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(frml, <span class="at">data =</span> .x)),</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">summary =</span> <span class="fu">map</span>(model, summary), </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">glanced =</span> <span class="fu">map</span>(model, glance),</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">augmented =</span> <span class="fu">map</span>(model, augment),</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">preds =</span> <span class="fu">map2</span>(model, data, </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">~</span><span class="fu">as.data.frame</span>(<span class="fu">predict</span>(.x, .y, <span class="at">interval =</span> <span class="st">"prediction"</span>)) )</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co"># show tibble</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>season_mods_nested</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 7
# Groups:   seasonfac [3]
  seasonfac data                model  summary    glanced  augmented preds 
  &lt;fct&gt;     &lt;list&gt;              &lt;list&gt; &lt;list&gt;     &lt;list&gt;   &lt;list&gt;    &lt;list&gt;
1 Summer    &lt;tibble [148 × 78]&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt; &lt;tibble&gt;  &lt;df&gt;  
2 Fall      &lt;tibble [152 × 78]&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt; &lt;tibble&gt;  &lt;df&gt;  
3 Winter    &lt;tibble [149 × 78]&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt; &lt;tibble&gt;  &lt;df&gt;  </code></pre>
</div>
</div>
<p>You can see <code>season_mods</code> is a grouped tibble with list-columns for each of the non-grouping variables. (Recall that “seasonfac” is the grouping variable.) Next we’ll demonstrate how to access these outputs separately to show what outputs the <code>glance()</code> (model summaries) and <code>augment()</code> (information about each observation like predictions and residuals) functions produce. Note that as an alternative you can incorporate the <code>unnest()</code> step into the pipeline in the previous chunk. We showed the <code>summary()</code>, <code>glance()</code>, <code>augment()</code>, and <code>predict()</code> functions above, but you can include or remove functions to suit your needs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----unnest-----</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># unnest glanced object - `glance()` provides model summaries</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">unnest</span>(season_mods_nested, glanced)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 18
# Groups:   seasonfac [3]
  seasonfac data     model  summary    r.squared adj.r.squared sigma statistic
  &lt;fct&gt;     &lt;list&gt;   &lt;list&gt; &lt;list&gt;         &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
1 Summer    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt;     0.725         0.711 0.208      52.8
2 Fall      &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt;     0.672         0.656 0.186      42.1
3 Winter    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt;     0.677         0.661 0.174      42.3
# ℹ 10 more variables: p.value &lt;dbl&gt;, df &lt;dbl&gt;, logLik &lt;dbl&gt;, AIC &lt;dbl&gt;,
#   BIC &lt;dbl&gt;, deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;, augmented &lt;list&gt;,
#   preds &lt;list&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># unnest augmented dataframe for ".fitted" and ".resid" values. Unfortunately, </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># the prediction intervals are not provided with `augment()`. We'll now assign </span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># this output to the `season_mods` object, but this could have been accomplished </span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># by continuing the pipeline in the previous chunk. We split up this pipeline </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># just to demonstrate how to access the different objects produced in the nest </span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># workflow.</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>season_mods <span class="ot">&lt;-</span> <span class="fu">unnest</span>(season_mods_nested, augmented)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># show augmented season_mods object</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>season_mods</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 449 × 20
# Groups:   seasonfac [3]
   seasonfac data     model  summary    glanced  ln_nox  D2A1 A1_50 A23_400
   &lt;fct&gt;     &lt;list&gt;   &lt;list&gt; &lt;list&gt;     &lt;list&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
 1 Summer    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt;   3.48  3.42     0  0     
 2 Summer    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt;   3.62  3.45     0  0.156 
 3 Summer    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt;   3.81  3.46     0  0.160 
 4 Summer    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt;   3.52  3.46     0  0.160 
 5 Summer    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt;   3.59  3.47     0  0.154 
 6 Summer    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt;   3.49  3.49     0  0.0828
 7 Summer    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt;   3.53  3.51     0  0.0381
 8 Summer    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt;   3.43  3.48     0  0.0757
 9 Summer    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt;   3.55  3.47     0  0.100 
10 Summer    &lt;tibble&gt; &lt;lm&gt;   &lt;smmry.lm&gt; &lt;tibble&gt;   3.43  3.45     0  0.120 
# ℹ 439 more rows
# ℹ 11 more variables: Pop_5000 &lt;dbl&gt;, D2C &lt;dbl&gt;, Int_3000 &lt;dbl&gt;, D2Comm &lt;dbl&gt;,
#   .fitted &lt;dbl&gt;, .resid &lt;dbl&gt;, .hat &lt;dbl&gt;, .sigma &lt;dbl&gt;, .cooksd &lt;dbl&gt;,
#   .std.resid &lt;dbl&gt;, preds &lt;list&gt;</code></pre>
</div>
</div>
</section>
<section id="regression-predictions" class="level1">
<h1>Regression predictions</h1>
<section id="output-from-nest-workflow" class="level2">
<h2 class="anchored" data-anchor-id="output-from-nest-workflow">Output from <code>nest()</code> workflow</h2>
<p>In the previous chunks we calculated in-sample predictions with <code>augment()</code>. The nesting workflow makes plotting those predictions easy:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----plot obs pred in sample-----</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate range of data</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">range</span>(season_mods[, <span class="fu">c</span>(<span class="st">"ln_nox"</span>, <span class="st">".fitted"</span>)])</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plot observations vs predictions for each season</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(season_mods, <span class="fu">aes</span>(<span class="at">x =</span> .fitted, <span class="at">y =</span> ln_nox)) <span class="sc">+</span> </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="st">"o"</span>) <span class="sc">+</span> </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>seasonfac, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lims</span>(<span class="at">x =</span> r, <span class="at">y =</span> r) <span class="sc">+</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"In-sample Predictions"</span>, </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"In-sample predicted ln(NOx) (ln(ppb))"</span>,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Observed ln(NOx) (ln(ppb))"</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>       ) <span class="sc">+</span> </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Week3LabCompanion_files/figure-html/plot.obs.pred.in.sample-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="calculating-predictions-programmatically" class="level2">
<h2 class="anchored" data-anchor-id="calculating-predictions-programmatically">Calculating predictions programmatically</h2>
<p>In <code>Week3Lab.Rmd</code> we specified each of the out-of-sample predictions we were interested in separately, for example:</p>
<pre><code>
fall_preds_from_summer &lt;- 
  predict(lm_summer, snapshot[snapshot$season == 2,], interval = "prediction")
</code></pre>
<p>This is quite clear what’s happening, but again, it requires us to specify the model, the data subset, and the object name for each set of out-of-sample predictions of interest.</p>
<p>Next we’ll demonstrate how to calculate the season-specific predictions in the dataset for all seasons programmatically. While <code>augment()</code> conveniently gave us “in-sample” predictions, the following approach will give us both “in-sample” predictions (e.g.&nbsp;using the summer model to make predictions in summer) and “out-of-sample” predictions (e.g.&nbsp;using the summer model to make predictions in winter). The extra step involved with this approach comes after this chunk. It is selecting the output of interest, for example, the “Winter_” columns from the Summer “seasonfac” rows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----predictions with dplyr-----</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># first, extract models from earlier regression procedures for convenience, </span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># setting the names of the models to match with their season</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> season_mods_nested<span class="sc">$</span>model <span class="sc">%&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">as.character</span>(season_mods_nested<span class="sc">$</span>seasonfac))</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># use lapply and an anonymous function to loop through the models</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>allseas_both <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(models), <span class="cf">function</span>(i){</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the predictions, intervals, and residuals for each season</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(models[[i]], snapshot, <span class="at">interval =</span> <span class="st">"prediction"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">resid =</span> snapshot[[<span class="st">"ln_nox"</span>]]<span class="sc">-</span>fit) <span class="sc">%&gt;%</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename columns to correspond to the season model</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename_all</span>(<span class="cf">function</span>(x){<span class="fu">paste0</span>(i, <span class="st">"_"</span>, x)})</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bind list of dataframes together</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(cbind) <span class="sc">%&gt;%</span> </span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add to snapshot dataframe</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(snapshot, .)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect predictions and residuals</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>allseas_both <span class="sc">%&gt;%</span> </span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seasonfac, ln_nox, <span class="fu">matches</span>(<span class="st">"_fit|_lwr|_upr|_resid"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 449 × 14
   seasonfac ln_nox Summer_fit Summer_lwr Summer_upr Summer_resid Fall_fit
   &lt;fct&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;
 1 Summer      3.48       3.55       3.13       3.98       -0.07      4.07
 2 Summer      3.62       3.62       3.20       4.04        0.001     4.22
 3 Summer      3.81       3.62       3.20       4.04        0.198     4.22
 4 Summer      3.52       3.61       3.19       4.03       -0.093     4.21
 5 Summer      3.60       3.6        3.18       4.02       -0.005     4.17
 6 Summer      3.49       3.55       3.13       3.97       -0.057     4.03
 7 Summer      3.53       3.49       3.07       3.91        0.044     4.39
 8 Summer      3.44       3.53       3.12       3.95       -0.099     4.53
 9 Summer      3.55       3.55       3.13       3.97       -0.003     4.56
10 Summer      3.43       3.56       3.14       3.98       -0.131     4.57
# ℹ 439 more rows
# ℹ 7 more variables: Fall_lwr &lt;dbl&gt;, Fall_upr &lt;dbl&gt;, Fall_resid &lt;dbl&gt;,
#   Winter_fit &lt;dbl&gt;, Winter_lwr &lt;dbl&gt;, Winter_upr &lt;dbl&gt;, Winter_resid &lt;dbl&gt;</code></pre>
</div>
</div>
<p>As we noted above, assessing the the quality of the predictions, as we did in <code>Week3Lab.Rmd</code> requires us to specify the data of interest since we’ve produced all predictions together:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----prediction assessment</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co"># summer in-sample</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"summer in-sample R2:  "</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(allseas_both <span class="sc">%&gt;%</span> <span class="fu">filter</span>(seasonfac <span class="sc">==</span> <span class="st">"Summer"</span>), </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">round</span>(<span class="fu">cor</span>(ln_nox, Summer_fit)<span class="sc">^</span><span class="dv">2</span>, <span class="dv">3</span>)) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "summer in-sample R2:   0.725"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summer out-of-sample (from winter model)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"summer out-of-sample R2 (from winter model):  "</span>, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(allseas_both <span class="sc">%&gt;%</span> <span class="fu">filter</span>(seasonfac <span class="sc">==</span> <span class="st">"Summer"</span>), </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">round</span>(<span class="fu">cor</span>(ln_nox, Winter_fit)<span class="sc">^</span><span class="dv">2</span>, <span class="dv">3</span>)) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "summer out-of-sample R2 (from winter model):   0.247"</code></pre>
</div>
</div>
</section>
<section id="plot-predictions" class="level2">
<h2 class="anchored" data-anchor-id="plot-predictions">Plot predictions</h2>
<p>We can define a flexible plot function to prevent repeating our plotting code: (Note that we will describe how to write functions in the Week 4 lab.)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----define plot function-----</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># make plot function</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>plot_func <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">df =</span> allseas_both, x_var, y_var, seas, </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                      x_lab, y_lab, plot_title){</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create function variable names with `enquo`</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">enquo</span>(x_var)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">enquo</span>(y_var)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get range of data to define the plotting range in the axes</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(seasonfac <span class="sc">==</span> seas) <span class="sc">%&gt;%</span> </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Summer_fit, Fall_fit, Winter_fit, ln_nox) <span class="sc">%&gt;%</span> </span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">range</span>()</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make plots</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(seasonfac <span class="sc">==</span> seas) <span class="sc">%&gt;%</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="sc">!!</span>x, <span class="at">y =</span> <span class="sc">!!</span>y)) <span class="sc">+</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="st">"o"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lims</span>(<span class="at">x =</span> r, <span class="at">y =</span> r) <span class="sc">+</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> plot_title, </span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> x_lab,</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> y_lab</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">+</span> </span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With the <code>allseas_both</code> dataframe (specified by default) we can plot in- and out-of-sample predictions like we did in <code>Week3Lab.Rmd</code> with our function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----summer in and out of sample-----</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the predictions vs. data for summer, both in-sample and out of sample</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co"># in-sample plot</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>p_in <span class="ot">&lt;-</span> <span class="fu">plot_func</span>(<span class="at">x_var =</span> Summer_fit, <span class="at">y_var =</span> ln_nox, <span class="at">seas =</span> <span class="st">"Summer"</span>, </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">x_lab =</span> <span class="st">"In-sample predicted ln(NOx) (ln(ppb))"</span>, </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y_lab =</span> <span class="st">"Observed ln(NOx) (ln(ppb))"</span>, </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">plot_title =</span> <span class="st">"In-sample"</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co"># out-of-sample plot (predictions from the winter model)</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>p_out <span class="ot">&lt;-</span> <span class="fu">plot_func</span>(<span class="at">x_var =</span> Winter_fit, <span class="at">y_var =</span> ln_nox, <span class="at">seas =</span> <span class="st">"Summer"</span>, </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">x_lab =</span> <span class="st">"Out-of-sample predicted ln(NOx) (ln(ppb))"</span>, </span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y_lab =</span> <span class="st">"Observed ln(NOx) (ln(ppb))"</span>, </span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">plot_title =</span> <span class="st">"Out-of-sample (from winter model)"</span> )</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># combine plots</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p_in, p_out, <span class="at">ncol =</span> <span class="dv">2</span>, </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">top =</span> <span class="st">"Summer Model ln(NOx) Predictions"</span>, </span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>          <span class="at">bottom =</span> <span class="st">"Best fit line is red; 1:1 line is blue"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Week3LabCompanion_files/figure-html/summer.in.and.out.sample-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here is an alternate approach for plotting all predictions from a single season simultaneously using <code>facet wrap()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----plot all predictions-----</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create temporary dataframe for ggplot</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> allseas_both <span class="sc">%&gt;%</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seasonfac, ln_nox, <span class="fu">contains</span>(<span class="st">"_fit"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(seasonfac <span class="sc">==</span> <span class="st">"Summer"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"_fit"</span>), <span class="at">names_to =</span> <span class="st">"season_fit"</span>, </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"fit"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">season_fit =</span> <span class="fu">factor</span>(<span class="fu">str_remove</span>(season_fit, <span class="st">"_fit"</span>), </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>                             <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Summer"</span>, <span class="st">"Fall"</span>, <span class="st">"Winter"</span>)) )</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># get range for plots</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> temp <span class="sc">%&gt;%</span> </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fit, ln_nox) <span class="sc">%&gt;%</span> </span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">range</span>()</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co"># make plot</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>pred_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> fit, <span class="at">y =</span> ln_nox) ) <span class="sc">+</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="st">"o"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span> </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>season_fit, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lims</span>(<span class="at">x =</span> r, <span class="at">y =</span> r) <span class="sc">+</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predictions with Summer Model"</span>, </span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Predicted ln(NOx) (ln(ppb))"</span>,</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Observed ln(NOx) (ln(ppb))"</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">+</span> </span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="co"># show plot</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>pred_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Week3LabCompanion_files/figure-html/plot.all.preds-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="appendix" class="level1">
<h1>Appendix</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----session information----</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># print R session information</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Sonoma 14.6.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Los_Angeles
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] stringr_1.5.1 purrr_1.0.2   broom_1.0.6   tidyr_1.3.1   egg_0.4.5    
 [6] gridExtra_2.3 ggplot2_3.5.1 dplyr_1.1.4   knitr_1.48    pacman_0.5.1 

loaded via a namespace (and not attached):
 [1] Matrix_1.6-1      gtable_0.3.5      jsonlite_1.8.9    compiler_4.3.1   
 [5] tidyselect_1.2.1  splines_4.3.1     scales_1.3.0      yaml_2.3.10      
 [9] fastmap_1.2.0     lattice_0.22-6    R6_2.5.1          labeling_0.4.3   
[13] generics_0.1.3    htmlwidgets_1.6.4 backports_1.5.0   tibble_3.2.1     
[17] munsell_0.5.1     pillar_1.9.0      rlang_1.1.4       utf8_1.2.4       
[21] stringi_1.8.4     xfun_0.47         cli_3.6.3         mgcv_1.9-1       
[25] withr_3.0.1       magrittr_2.0.3    digest_0.6.37     grid_4.3.1       
[29] rstudioapi_0.16.0 nlme_3.1-166      lifecycle_1.0.4   vctrs_0.6.5      
[33] evaluate_1.0.0    glue_1.7.0        farver_2.1.2      fansi_1.0.6      
[37] colorspace_2.1-1  rmarkdown_2.28    tools_4.3.1       pkgconfig_2.0.3  
[41] htmltools_0.5.8.1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----setup-----</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set knitr options</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">echo =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># clear work space of all objects and unload all extra (non-base) packages</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>(<span class="at">all =</span> <span class="cn">TRUE</span>))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">sessionInfo</span>()<span class="sc">$</span>otherPkgs)) {</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lapply</span>(<span class="fu">paste</span>(<span class="st">'package:'</span>, <span class="fu">names</span>(<span class="fu">sessionInfo</span>()<span class="sc">$</span>otherPkgs), <span class="at">sep=</span><span class="st">""</span>),</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>               detach, <span class="at">character.only=</span><span class="cn">TRUE</span>, <span class="at">unload=</span><span class="cn">TRUE</span>, <span class="at">force=</span><span class="cn">TRUE</span>))</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co">#-----load libraries pacman-----</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Load pacman into memory, installing as needed</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>my_repo <span class="ot">&lt;-</span> <span class="st">'http://cran.r-project.org'</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) {<span class="fu">install.packages</span>(<span class="st">"pacman"</span>, <span class="at">repos =</span> my_repo)}</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the other packages, installing as needed.  Some reasons for packages:</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(knitr, dplyr, ggplot2, egg, tidyr, broom, purrr, stringr)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="co">#-----directory organization and read data-----</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="co"># specify working directory</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>project_path <span class="ot">&lt;-</span> <span class="fu">getwd</span>()</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="co"># create "Datasets" directory if one does not already exist    </span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">file.path</span>(project_path,<span class="st">"Datasets"</span>), <span class="at">showWarnings=</span><span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="co"># specify data path</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>data_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(project_path,<span class="st">"Datasets"</span>)</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a><span class="co"># specify the file name and path</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>file_name <span class="ot">&lt;-</span> <span class="st">"allseasonsR.rds"</span></span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(data_path, file_name)</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the file if it is not already present</span></span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>    url <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"https://staff.washington.edu/high/envh556/Datasets"</span>, </span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>                 file_name, <span class="at">sep =</span> <span class="st">'/'</span>)</span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">download.file</span>(<span class="at">url =</span> url, <span class="at">destfile =</span> file_path)</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Output a warning message if the file cannot be found</span></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>    snapshot <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file_path)</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="fu">warning</span>(<span class="fu">paste</span>(<span class="st">"Can't find"</span>, file_name, <span class="st">"!"</span>))</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a><span class="co"># remove temporary variables</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(url, file_name, file_path, data_path)</span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a><span class="co">#-----prep snapshot-----</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a><span class="co"># transform snapshot dataframe to tibble and modify season factor</span></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a>snapshot <span class="ot">&lt;-</span> snapshot <span class="sc">%&gt;%</span> </span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">seasonfac =</span> <span class="fu">factor</span>(<span class="fu">str_remove</span>(seasonfac, <span class="st">"[:digit:]"</span>),   </span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a>         <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Summer"</span>, <span class="st">"Fall"</span>, <span class="st">"Winter"</span>)) )</span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a><span class="co"># create season variable (to be used throughout analysis)</span></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>seasons <span class="ot">&lt;-</span> <span class="fu">unique</span>(snapshot<span class="sc">$</span>seasonfac)</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a><span class="co">#-----summarize ln_nox-----</span></span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a><span class="co"># frequencies only</span></span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(snapshot<span class="sc">$</span>seasonfac)</span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a><span class="co"># descriptive statistics</span></span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>snapshot_summary <span class="ot">&lt;-</span> snapshot <span class="sc">%&gt;%</span></span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(seasonfac) <span class="sc">%&gt;%</span></span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a>              <span class="at">Mean =</span> <span class="fu">mean</span>(ln_nox), </span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a>              <span class="at">SD =</span> <span class="fu">sd</span>(ln_nox),</span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a>              <span class="at">GM =</span> <span class="fu">exp</span>(<span class="fu">mean</span>(ln_nox)), </span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a>              <span class="at">GSD =</span> <span class="fu">exp</span>(<span class="fu">sd</span>(ln_nox)), </span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">2</span>)</span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a><span class="co"># show summary</span></span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a>snapshot_summary</span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a><span class="co">#-----season-specific boxplots-----</span></span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(snapshot, <span class="fu">aes</span>(<span class="at">x =</span> seasonfac, <span class="at">y =</span> ln_nox, <span class="at">fill =</span> seasonfac)) <span class="sc">+</span></span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>() <span class="sc">+</span></span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Season"</span>, </span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"ln(NOx) (ln(ppb)"</span>, </span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Season"</span>, </span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a>         <span class="at">fill =</span> <span class="st">"Season"</span>) <span class="sc">+</span> </span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_article</span>()</span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a><span class="co">#-----regression for association-----</span></span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Common model (Table 4), season-specific LUR from Mercer et al, 2011</span></span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a><span class="co"># specify the "common model"</span></span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a>frml <span class="ot">&lt;-</span></span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.formula</span>(ln_nox <span class="sc">~</span> D2A1 <span class="sc">+</span> A1_50 <span class="sc">+</span> A23_400 <span class="sc">+</span> Pop_5000 <span class="sc">+</span> D2C <span class="sc">+</span> Int_3000 <span class="sc">+</span> D2Comm)</span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a><span class="co"># create tibble with nested seasonal models</span></span>
<span id="cb26-103"><a href="#cb26-103" aria-hidden="true" tabindex="-1"></a>season_mods_nested <span class="ot">&lt;-</span> snapshot <span class="sc">%&gt;%</span></span>
<span id="cb26-104"><a href="#cb26-104" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-105"><a href="#cb26-105" aria-hidden="true" tabindex="-1"></a>  <span class="co"># group by season, then "nest"</span></span>
<span id="cb26-106"><a href="#cb26-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(seasonfac) <span class="sc">%&gt;%</span> </span>
<span id="cb26-107"><a href="#cb26-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb26-108"><a href="#cb26-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-109"><a href="#cb26-109" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fit regression model for each season and generate summary, glance, augment,</span></span>
<span id="cb26-110"><a href="#cb26-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and in-sample prediction outputs with prediction intervals.</span></span>
<span id="cb26-111"><a href="#cb26-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(frml, <span class="at">data =</span> .x)),</span>
<span id="cb26-112"><a href="#cb26-112" aria-hidden="true" tabindex="-1"></a>         <span class="at">summary =</span> <span class="fu">map</span>(model, summary), </span>
<span id="cb26-113"><a href="#cb26-113" aria-hidden="true" tabindex="-1"></a>         <span class="at">glanced =</span> <span class="fu">map</span>(model, glance),</span>
<span id="cb26-114"><a href="#cb26-114" aria-hidden="true" tabindex="-1"></a>         <span class="at">augmented =</span> <span class="fu">map</span>(model, augment),</span>
<span id="cb26-115"><a href="#cb26-115" aria-hidden="true" tabindex="-1"></a>         <span class="at">preds =</span> <span class="fu">map2</span>(model, data, </span>
<span id="cb26-116"><a href="#cb26-116" aria-hidden="true" tabindex="-1"></a>                      <span class="sc">~</span><span class="fu">as.data.frame</span>(<span class="fu">predict</span>(.x, .y, <span class="at">interval =</span> <span class="st">"prediction"</span>)) )</span>
<span id="cb26-117"><a href="#cb26-117" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb26-118"><a href="#cb26-118" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb26-119"><a href="#cb26-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-120"><a href="#cb26-120" aria-hidden="true" tabindex="-1"></a><span class="co"># show tibble</span></span>
<span id="cb26-121"><a href="#cb26-121" aria-hidden="true" tabindex="-1"></a>season_mods_nested</span>
<span id="cb26-122"><a href="#cb26-122" aria-hidden="true" tabindex="-1"></a><span class="co">#-----unnest-----</span></span>
<span id="cb26-123"><a href="#cb26-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-124"><a href="#cb26-124" aria-hidden="true" tabindex="-1"></a><span class="co"># unnest glanced object - `glance()` provides model summaries</span></span>
<span id="cb26-125"><a href="#cb26-125" aria-hidden="true" tabindex="-1"></a><span class="fu">unnest</span>(season_mods_nested, glanced)</span>
<span id="cb26-126"><a href="#cb26-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-127"><a href="#cb26-127" aria-hidden="true" tabindex="-1"></a><span class="co"># unnest augmented dataframe for ".fitted" and ".resid" values. Unfortunately, </span></span>
<span id="cb26-128"><a href="#cb26-128" aria-hidden="true" tabindex="-1"></a><span class="co"># the prediction intervals are not provided with `augment()`. We'll now assign </span></span>
<span id="cb26-129"><a href="#cb26-129" aria-hidden="true" tabindex="-1"></a><span class="co"># this output to the `season_mods` object, but this could have been accomplished </span></span>
<span id="cb26-130"><a href="#cb26-130" aria-hidden="true" tabindex="-1"></a><span class="co"># by continuing the pipeline in the previous chunk. We split up this pipeline </span></span>
<span id="cb26-131"><a href="#cb26-131" aria-hidden="true" tabindex="-1"></a><span class="co"># just to demonstrate how to access the different objects produced in the nest </span></span>
<span id="cb26-132"><a href="#cb26-132" aria-hidden="true" tabindex="-1"></a><span class="co"># workflow.</span></span>
<span id="cb26-133"><a href="#cb26-133" aria-hidden="true" tabindex="-1"></a>season_mods <span class="ot">&lt;-</span> <span class="fu">unnest</span>(season_mods_nested, augmented)</span>
<span id="cb26-134"><a href="#cb26-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-135"><a href="#cb26-135" aria-hidden="true" tabindex="-1"></a><span class="co"># show augmented season_mods object</span></span>
<span id="cb26-136"><a href="#cb26-136" aria-hidden="true" tabindex="-1"></a>season_mods</span>
<span id="cb26-137"><a href="#cb26-137" aria-hidden="true" tabindex="-1"></a><span class="co">#-----plot obs pred in sample-----</span></span>
<span id="cb26-138"><a href="#cb26-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-139"><a href="#cb26-139" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate range of data</span></span>
<span id="cb26-140"><a href="#cb26-140" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">range</span>(season_mods[, <span class="fu">c</span>(<span class="st">"ln_nox"</span>, <span class="st">".fitted"</span>)])</span>
<span id="cb26-141"><a href="#cb26-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-142"><a href="#cb26-142" aria-hidden="true" tabindex="-1"></a><span class="co"># plot observations vs predictions for each season</span></span>
<span id="cb26-143"><a href="#cb26-143" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(season_mods, <span class="fu">aes</span>(<span class="at">x =</span> .fitted, <span class="at">y =</span> ln_nox)) <span class="sc">+</span> </span>
<span id="cb26-144"><a href="#cb26-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="st">"o"</span>) <span class="sc">+</span> </span>
<span id="cb26-145"><a href="#cb26-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>seasonfac, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb26-146"><a href="#cb26-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lims</span>(<span class="at">x =</span> r, <span class="at">y =</span> r) <span class="sc">+</span></span>
<span id="cb26-147"><a href="#cb26-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb26-148"><a href="#cb26-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb26-149"><a href="#cb26-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb26-150"><a href="#cb26-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"In-sample Predictions"</span>, </span>
<span id="cb26-151"><a href="#cb26-151" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"In-sample predicted ln(NOx) (ln(ppb))"</span>,</span>
<span id="cb26-152"><a href="#cb26-152" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Observed ln(NOx) (ln(ppb))"</span></span>
<span id="cb26-153"><a href="#cb26-153" aria-hidden="true" tabindex="-1"></a>       ) <span class="sc">+</span> </span>
<span id="cb26-154"><a href="#cb26-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb26-155"><a href="#cb26-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-156"><a href="#cb26-156" aria-hidden="true" tabindex="-1"></a><span class="co">#-----predictions with dplyr-----</span></span>
<span id="cb26-157"><a href="#cb26-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-158"><a href="#cb26-158" aria-hidden="true" tabindex="-1"></a><span class="co"># first, extract models from earlier regression procedures for convenience, </span></span>
<span id="cb26-159"><a href="#cb26-159" aria-hidden="true" tabindex="-1"></a><span class="co"># setting the names of the models to match with their season</span></span>
<span id="cb26-160"><a href="#cb26-160" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> season_mods_nested<span class="sc">$</span>model <span class="sc">%&gt;%</span></span>
<span id="cb26-161"><a href="#cb26-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">as.character</span>(season_mods_nested<span class="sc">$</span>seasonfac))</span>
<span id="cb26-162"><a href="#cb26-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-163"><a href="#cb26-163" aria-hidden="true" tabindex="-1"></a><span class="co"># use lapply and an anonymous function to loop through the models</span></span>
<span id="cb26-164"><a href="#cb26-164" aria-hidden="true" tabindex="-1"></a>allseas_both <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(models), <span class="cf">function</span>(i){</span>
<span id="cb26-165"><a href="#cb26-165" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-166"><a href="#cb26-166" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add the predictions, intervals, and residuals for each season</span></span>
<span id="cb26-167"><a href="#cb26-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(models[[i]], snapshot, <span class="at">interval =</span> <span class="st">"prediction"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-168"><a href="#cb26-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb26-169"><a href="#cb26-169" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">resid =</span> snapshot[[<span class="st">"ln_nox"</span>]]<span class="sc">-</span>fit) <span class="sc">%&gt;%</span></span>
<span id="cb26-170"><a href="#cb26-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-171"><a href="#cb26-171" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rename columns to correspond to the season model</span></span>
<span id="cb26-172"><a href="#cb26-172" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename_all</span>(<span class="cf">function</span>(x){<span class="fu">paste0</span>(i, <span class="st">"_"</span>, x)})</span>
<span id="cb26-173"><a href="#cb26-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-174"><a href="#cb26-174" aria-hidden="true" tabindex="-1"></a>  }) <span class="sc">%&gt;%</span> </span>
<span id="cb26-175"><a href="#cb26-175" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-176"><a href="#cb26-176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># bind list of dataframes together</span></span>
<span id="cb26-177"><a href="#cb26-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reduce</span>(cbind) <span class="sc">%&gt;%</span> </span>
<span id="cb26-178"><a href="#cb26-178" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-179"><a href="#cb26-179" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add to snapshot dataframe</span></span>
<span id="cb26-180"><a href="#cb26-180" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(snapshot, .)</span>
<span id="cb26-181"><a href="#cb26-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-182"><a href="#cb26-182" aria-hidden="true" tabindex="-1"></a><span class="co"># inspect predictions and residuals</span></span>
<span id="cb26-183"><a href="#cb26-183" aria-hidden="true" tabindex="-1"></a>allseas_both <span class="sc">%&gt;%</span> </span>
<span id="cb26-184"><a href="#cb26-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seasonfac, ln_nox, <span class="fu">matches</span>(<span class="st">"_fit|_lwr|_upr|_resid"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-185"><a href="#cb26-185" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate_if</span>(is.double, round, <span class="dv">3</span>)</span>
<span id="cb26-186"><a href="#cb26-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-187"><a href="#cb26-187" aria-hidden="true" tabindex="-1"></a><span class="co">#-----prediction assessment</span></span>
<span id="cb26-188"><a href="#cb26-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-189"><a href="#cb26-189" aria-hidden="true" tabindex="-1"></a><span class="co"># summer in-sample</span></span>
<span id="cb26-190"><a href="#cb26-190" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"summer in-sample R2:  "</span>,</span>
<span id="cb26-191"><a href="#cb26-191" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(allseas_both <span class="sc">%&gt;%</span> <span class="fu">filter</span>(seasonfac <span class="sc">==</span> <span class="st">"Summer"</span>), </span>
<span id="cb26-192"><a href="#cb26-192" aria-hidden="true" tabindex="-1"></a>     <span class="fu">round</span>(<span class="fu">cor</span>(ln_nox, Summer_fit)<span class="sc">^</span><span class="dv">2</span>, <span class="dv">3</span>)) )</span>
<span id="cb26-193"><a href="#cb26-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-194"><a href="#cb26-194" aria-hidden="true" tabindex="-1"></a><span class="co"># summer out-of-sample (from winter model)</span></span>
<span id="cb26-195"><a href="#cb26-195" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"summer out-of-sample R2 (from winter model):  "</span>, </span>
<span id="cb26-196"><a href="#cb26-196" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(allseas_both <span class="sc">%&gt;%</span> <span class="fu">filter</span>(seasonfac <span class="sc">==</span> <span class="st">"Summer"</span>), </span>
<span id="cb26-197"><a href="#cb26-197" aria-hidden="true" tabindex="-1"></a>     <span class="fu">round</span>(<span class="fu">cor</span>(ln_nox, Winter_fit)<span class="sc">^</span><span class="dv">2</span>, <span class="dv">3</span>)) )</span>
<span id="cb26-198"><a href="#cb26-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-199"><a href="#cb26-199" aria-hidden="true" tabindex="-1"></a><span class="co">#-----define plot function-----</span></span>
<span id="cb26-200"><a href="#cb26-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-201"><a href="#cb26-201" aria-hidden="true" tabindex="-1"></a><span class="co"># make plot function</span></span>
<span id="cb26-202"><a href="#cb26-202" aria-hidden="true" tabindex="-1"></a>plot_func <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">df =</span> allseas_both, x_var, y_var, seas, </span>
<span id="cb26-203"><a href="#cb26-203" aria-hidden="true" tabindex="-1"></a>                      x_lab, y_lab, plot_title){</span>
<span id="cb26-204"><a href="#cb26-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-205"><a href="#cb26-205" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create function variable names with `enquo`</span></span>
<span id="cb26-206"><a href="#cb26-206" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">enquo</span>(x_var)</span>
<span id="cb26-207"><a href="#cb26-207" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">enquo</span>(y_var)</span>
<span id="cb26-208"><a href="#cb26-208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-209"><a href="#cb26-209" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get range of data to define the plotting range in the axes</span></span>
<span id="cb26-210"><a href="#cb26-210" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb26-211"><a href="#cb26-211" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(seasonfac <span class="sc">==</span> seas) <span class="sc">%&gt;%</span> </span>
<span id="cb26-212"><a href="#cb26-212" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Summer_fit, Fall_fit, Winter_fit, ln_nox) <span class="sc">%&gt;%</span> </span>
<span id="cb26-213"><a href="#cb26-213" aria-hidden="true" tabindex="-1"></a>    <span class="fu">range</span>()</span>
<span id="cb26-214"><a href="#cb26-214" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-215"><a href="#cb26-215" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make plots</span></span>
<span id="cb26-216"><a href="#cb26-216" aria-hidden="true" tabindex="-1"></a>  df <span class="sc">%&gt;%</span></span>
<span id="cb26-217"><a href="#cb26-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(seasonfac <span class="sc">==</span> seas) <span class="sc">%&gt;%</span></span>
<span id="cb26-218"><a href="#cb26-218" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="sc">!!</span>x, <span class="at">y =</span> <span class="sc">!!</span>y)) <span class="sc">+</span></span>
<span id="cb26-219"><a href="#cb26-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="st">"o"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb26-220"><a href="#cb26-220" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lims</span>(<span class="at">x =</span> r, <span class="at">y =</span> r) <span class="sc">+</span></span>
<span id="cb26-221"><a href="#cb26-221" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb26-222"><a href="#cb26-222" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb26-223"><a href="#cb26-223" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb26-224"><a href="#cb26-224" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> plot_title, </span>
<span id="cb26-225"><a href="#cb26-225" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> x_lab,</span>
<span id="cb26-226"><a href="#cb26-226" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> y_lab</span>
<span id="cb26-227"><a href="#cb26-227" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">+</span> </span>
<span id="cb26-228"><a href="#cb26-228" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb26-229"><a href="#cb26-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-230"><a href="#cb26-230" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-231"><a href="#cb26-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-232"><a href="#cb26-232" aria-hidden="true" tabindex="-1"></a><span class="co">#-----summer in and out of sample-----</span></span>
<span id="cb26-233"><a href="#cb26-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-234"><a href="#cb26-234" aria-hidden="true" tabindex="-1"></a><span class="co"># plot the predictions vs. data for summer, both in-sample and out of sample</span></span>
<span id="cb26-235"><a href="#cb26-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-236"><a href="#cb26-236" aria-hidden="true" tabindex="-1"></a><span class="co"># in-sample plot</span></span>
<span id="cb26-237"><a href="#cb26-237" aria-hidden="true" tabindex="-1"></a>p_in <span class="ot">&lt;-</span> <span class="fu">plot_func</span>(<span class="at">x_var =</span> Summer_fit, <span class="at">y_var =</span> ln_nox, <span class="at">seas =</span> <span class="st">"Summer"</span>, </span>
<span id="cb26-238"><a href="#cb26-238" aria-hidden="true" tabindex="-1"></a>                  <span class="at">x_lab =</span> <span class="st">"In-sample predicted ln(NOx) (ln(ppb))"</span>, </span>
<span id="cb26-239"><a href="#cb26-239" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y_lab =</span> <span class="st">"Observed ln(NOx) (ln(ppb))"</span>, </span>
<span id="cb26-240"><a href="#cb26-240" aria-hidden="true" tabindex="-1"></a>                  <span class="at">plot_title =</span> <span class="st">"In-sample"</span>)</span>
<span id="cb26-241"><a href="#cb26-241" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb26-242"><a href="#cb26-242" aria-hidden="true" tabindex="-1"></a><span class="co"># out-of-sample plot (predictions from the winter model)</span></span>
<span id="cb26-243"><a href="#cb26-243" aria-hidden="true" tabindex="-1"></a>p_out <span class="ot">&lt;-</span> <span class="fu">plot_func</span>(<span class="at">x_var =</span> Winter_fit, <span class="at">y_var =</span> ln_nox, <span class="at">seas =</span> <span class="st">"Summer"</span>, </span>
<span id="cb26-244"><a href="#cb26-244" aria-hidden="true" tabindex="-1"></a>                   <span class="at">x_lab =</span> <span class="st">"Out-of-sample predicted ln(NOx) (ln(ppb))"</span>, </span>
<span id="cb26-245"><a href="#cb26-245" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y_lab =</span> <span class="st">"Observed ln(NOx) (ln(ppb))"</span>, </span>
<span id="cb26-246"><a href="#cb26-246" aria-hidden="true" tabindex="-1"></a>                   <span class="at">plot_title =</span> <span class="st">"Out-of-sample (from winter model)"</span> )</span>
<span id="cb26-247"><a href="#cb26-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-248"><a href="#cb26-248" aria-hidden="true" tabindex="-1"></a><span class="co"># combine plots</span></span>
<span id="cb26-249"><a href="#cb26-249" aria-hidden="true" tabindex="-1"></a><span class="fu">ggarrange</span>(p_in, p_out, <span class="at">ncol =</span> <span class="dv">2</span>, </span>
<span id="cb26-250"><a href="#cb26-250" aria-hidden="true" tabindex="-1"></a>          <span class="at">top =</span> <span class="st">"Summer Model ln(NOx) Predictions"</span>, </span>
<span id="cb26-251"><a href="#cb26-251" aria-hidden="true" tabindex="-1"></a>          <span class="at">bottom =</span> <span class="st">"Best fit line is red; 1:1 line is blue"</span>)</span>
<span id="cb26-252"><a href="#cb26-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-253"><a href="#cb26-253" aria-hidden="true" tabindex="-1"></a><span class="co">#-----plot all predictions-----</span></span>
<span id="cb26-254"><a href="#cb26-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-255"><a href="#cb26-255" aria-hidden="true" tabindex="-1"></a><span class="co"># create temporary dataframe for ggplot</span></span>
<span id="cb26-256"><a href="#cb26-256" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> allseas_both <span class="sc">%&gt;%</span> </span>
<span id="cb26-257"><a href="#cb26-257" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(seasonfac, ln_nox, <span class="fu">contains</span>(<span class="st">"_fit"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-258"><a href="#cb26-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(seasonfac <span class="sc">==</span> <span class="st">"Summer"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-259"><a href="#cb26-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">contains</span>(<span class="st">"_fit"</span>), <span class="at">names_to =</span> <span class="st">"season_fit"</span>, </span>
<span id="cb26-260"><a href="#cb26-260" aria-hidden="true" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">"fit"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-261"><a href="#cb26-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">season_fit =</span> <span class="fu">factor</span>(<span class="fu">str_remove</span>(season_fit, <span class="st">"_fit"</span>), </span>
<span id="cb26-262"><a href="#cb26-262" aria-hidden="true" tabindex="-1"></a>                             <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Summer"</span>, <span class="st">"Fall"</span>, <span class="st">"Winter"</span>)) )</span>
<span id="cb26-263"><a href="#cb26-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-264"><a href="#cb26-264" aria-hidden="true" tabindex="-1"></a><span class="co"># get range for plots</span></span>
<span id="cb26-265"><a href="#cb26-265" aria-hidden="true" tabindex="-1"></a>  r <span class="ot">&lt;-</span> temp <span class="sc">%&gt;%</span> </span>
<span id="cb26-266"><a href="#cb26-266" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(fit, ln_nox) <span class="sc">%&gt;%</span> </span>
<span id="cb26-267"><a href="#cb26-267" aria-hidden="true" tabindex="-1"></a>    <span class="fu">range</span>()</span>
<span id="cb26-268"><a href="#cb26-268" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-269"><a href="#cb26-269" aria-hidden="true" tabindex="-1"></a><span class="co"># make plot</span></span>
<span id="cb26-270"><a href="#cb26-270" aria-hidden="true" tabindex="-1"></a>pred_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> temp, <span class="fu">aes</span>(<span class="at">x =</span> fit, <span class="at">y =</span> ln_nox) ) <span class="sc">+</span></span>
<span id="cb26-271"><a href="#cb26-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="st">"o"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span> </span>
<span id="cb26-272"><a href="#cb26-272" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>season_fit, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb26-273"><a href="#cb26-273" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lims</span>(<span class="at">x =</span> r, <span class="at">y =</span> r) <span class="sc">+</span></span>
<span id="cb26-274"><a href="#cb26-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb26-275"><a href="#cb26-275" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb26-276"><a href="#cb26-276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb26-277"><a href="#cb26-277" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Predictions with Summer Model"</span>, </span>
<span id="cb26-278"><a href="#cb26-278" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Predicted ln(NOx) (ln(ppb))"</span>,</span>
<span id="cb26-279"><a href="#cb26-279" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Observed ln(NOx) (ln(ppb))"</span></span>
<span id="cb26-280"><a href="#cb26-280" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">+</span> </span>
<span id="cb26-281"><a href="#cb26-281" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb26-282"><a href="#cb26-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-283"><a href="#cb26-283" aria-hidden="true" tabindex="-1"></a><span class="co"># show plot</span></span>
<span id="cb26-284"><a href="#cb26-284" aria-hidden="true" tabindex="-1"></a>pred_plot</span>
<span id="cb26-285"><a href="#cb26-285" aria-hidden="true" tabindex="-1"></a><span class="co">#-----session information----</span></span>
<span id="cb26-286"><a href="#cb26-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-287"><a href="#cb26-287" aria-hidden="true" tabindex="-1"></a><span class="co"># print R session information</span></span>
<span id="cb26-288"><a href="#cb26-288" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb26-289"><a href="#cb26-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-290"><a href="#cb26-290" aria-hidden="true" tabindex="-1"></a><span class="co">#-----code appendix----</span></span>
<span id="cb26-291"><a href="#cb26-291" aria-hidden="true" tabindex="-1"></a><span class="co">#-----functions----</span></span>
<span id="cb26-292"><a href="#cb26-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-293"><a href="#cb26-293" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the names of all functions defined in the .Rmd</span></span>
<span id="cb26-294"><a href="#cb26-294" aria-hidden="true" tabindex="-1"></a><span class="co"># (e.g. loaded in the environment)</span></span>
<span id="cb26-295"><a href="#cb26-295" aria-hidden="true" tabindex="-1"></a><span class="fu">lsf.str</span>()</span>
<span id="cb26-296"><a href="#cb26-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-297"><a href="#cb26-297" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the definitions of all functions loaded into the current environment  </span></span>
<span id="cb26-298"><a href="#cb26-298" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(<span class="fu">c</span>(<span class="fu">lsf.str</span>()), getAnywhere)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----functions----</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the names of all functions defined in the .Rmd</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># (e.g. loaded in the environment)</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lsf.str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>plot_func : function (df = allseas_both, x_var, y_var, seas, x_lab, y_lab, plot_title)  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the definitions of all functions loaded into the current environment  </span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(<span class="fu">c</span>(<span class="fu">lsf.str</span>()), getAnywhere)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
A single object matching 'plot_func' was found
It was found in the following places
  .GlobalEnv
with value

&lt;srcref: file "" chars 4:14 to 32:1&gt;
&lt;bytecode: 0x133296e08&gt;</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>