<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lianne Sheppard for ENVH 556 Autumn 2024">

<title>Week 2 Lab: Compliance – Descriptive Statistics and exceedance Probabilities</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Week2Lab_files/libs/clipboard/clipboard.min.js"></script>
<script src="Week2Lab_files/libs/quarto-html/quarto.js"></script>
<script src="Week2Lab_files/libs/quarto-html/popper.min.js"></script>
<script src="Week2Lab_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Week2Lab_files/libs/quarto-html/anchor.min.js"></script>
<link href="Week2Lab_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Week2Lab_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Week2Lab_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Week2Lab_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Week2Lab_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 2 Lab: Compliance – Descriptive Statistics and exceedance Probabilities</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Lianne Sheppard for ENVH 556 Autumn 2024 </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>This document was rendered on September 25, 2024.</p>
<section id="purpose" class="level1">
<h1>Purpose</h1>
<p>The purpose of this lab is to work with descriptive statistics and compliance tests while also getting further practice with R, RStudio, and Markdown. We will use the DEMS REC data, describing the distributions, exceedance probabilities, confidence intervals, and test compliance.</p>
</section>
<section id="getting-started" class="level1">
<h1>Getting Started</h1>
<p>This section gives formulas and some basic R commands for descriptive statistics and exceedance probabilities. It also provides reminders of formulas from lecture you will use in lab.</p>
<section id="definitions" class="level2">
<h2 class="anchored" data-anchor-id="definitions">Definitions</h2>
<ul>
<li>AM = arithmetic mean<br>
</li>
<li>GM = geometric mean<br>
</li>
<li>SD = standard deviation (on the native scale)</li>
<li>GSD = geometric standard deviation</li>
<li>MOM = method of moments</li>
<li>MLE = maximum likelihood estimate</li>
<li>OEL = occupational exposure limit</li>
<li>CI = confidence interval</li>
</ul>
</section>
<section id="formulas-for-method-of-moments-vs-mle-estimates-for-the-am" class="level2">
<h2 class="anchored" data-anchor-id="formulas-for-method-of-moments-vs-mle-estimates-for-the-am">Formulas for method of moments vs MLE estimates for the AM</h2>
<ul>
<li><p>AM method of moments (MOM) estimate for <code>ecdata</code> = <span class="math inline">\(x\)</span>: <span class="math display">\[\bar{x}_{MOM} = \frac{1}{n} \sum_{i=1}^{n} x_i \]</span></p></li>
<li><p>AM maximum likelihood estimate (MLE) for <code>ecdata</code> = <span class="math inline">\(x\)</span> using <code>lnrec</code> = <code>log(ecdata)</code> = <span class="math inline">\(y\)</span>: <span class="math display">\[ AM_{MLE}=\exp\big(\mu_y+\frac{\sigma_y^2}{2}\big)\]</span> <span class="math display">\[ \bar{x}_{MLE}=\exp{\big(\bar{y}+\frac{\frac{N-1}{N}s_y^2)}{2}\big)}\]</span></p></li>
</ul>
</section>
<section id="formulas-for-the-exceedance-fraction" class="level2">
<h2 class="anchored" data-anchor-id="formulas-for-the-exceedance-fraction">Formulas for the exceedance fraction</h2>
<ul>
<li><strong>Empiric exceedance fraction</strong>: For a sample of size <em>N</em> where <em>n</em> is the number exceeding the OEL, calculate <span class="math display">\[f_{OEL}=\frac{n&gt;\mbox{OEL}}{N}\]</span></li>
<li><strong>Parametric exceedance fraction</strong>: For a sample, log-transform the data and OEL and use the normal distribution to estimate the probability of exceeding ln(OEL): <span class="math display">\[P\big(y&gt;\ln(OEL)\big) =
\big(1-\Phi(z=\frac{y-\bar{y}}{s_y}&gt;\frac{\ln(OEL)-\bar{y}}{s_y})\big)\]</span></li>
</ul>
</section>
<section id="basic-data-manipulation-and-summarization-commands" class="level2">
<h2 class="anchored" data-anchor-id="basic-data-manipulation-and-summarization-commands">Basic data manipulation and summarization commands</h2>
<p>(See also Week 1 lab)</p>
<ol class="example" type="1">
<li><strong>Make a tibble</strong>: First let’s turn our DEMS dataset into a tibble. Tibbles are dataframes of the <code>tidyverse</code>, with some functional and aesthetic differences compared to regular data.frames. Tibbles will facilitate our use of <code>tidyverse</code> functions.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----create tibble----</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>DEMS <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(DEMS)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="2" class="example" type="1">
<li><strong>Keep a subset of observations:</strong> Keep only a subset of the data based on selected jobs (240,110,410,600), underground only (“u”), and <code>ecdata</code> being non-missing:</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----filter data----</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># filter dataset to keep underground only; 4 jobs codes: 240,110,410,600; and </span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># non-missing ecdata. </span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>DEMSu <span class="ot">&lt;-</span> <span class="fu">filter</span>(DEMS, </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                u_s <span class="sc">==</span> <span class="st">"u"</span>, </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                job <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">240</span>, <span class="dv">110</span>, <span class="dv">410</span>, <span class="dv">600</span>), </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                <span class="sc">!</span><span class="fu">is.na</span>(ecdata) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="3" class="example" type="1">
<li><strong>Create new variables</strong> using the log transformation. Typically exposure data appear to be log-normally distributed.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----transform vars----</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The natural log and log base 10 transformations of ecdata will be added to the </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># DEMSu tibble:</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>DEMSu <span class="ot">&lt;-</span> <span class="fu">mutate</span>(DEMSu,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">lnrec =</span> <span class="fu">log</span>(ecdata),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                <span class="at">log10rec =</span> <span class="fu">log10</span>(ecdata) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol start="4" class="example" type="1">
<li><strong>Summarize variables and display key quantities:</strong> This code uses <code>dplyr</code>, part of <code>tidyverse</code>. We use <code>group_by()</code> to determine the subgroups we are going to summarize over, <code>summarise()</code> to create new summaries we want to report, <code>mutate_if()</code> to ease rounding all variables of class <code>double</code>, and <code>arrange()</code> to decide the final ordering in the table. Each of these is connected though the pipe operator (<code>%&gt;%</code>) which can be read as “then”. It facilitates the process of connecting multiple steps without creating intermediate datasets by using the output of one function as the input of the next function in the “pipeline.”</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----table with dplyr----</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create summary </span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># note: "summarize()" will call a different function from the Hmisc package</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>DEMSsummary <span class="ot">&lt;-</span> DEMSu <span class="sc">%&gt;%</span> </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(job,facilityid) <span class="sc">%&gt;%</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">AM =</span> <span class="fu">mean</span>(ecdata),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">AM_mle =</span> (<span class="fu">exp</span>(<span class="fu">mean</span>(lnrec)<span class="sc">+</span>((N<span class="dv">-1</span>)<span class="sc">/</span>N)<span class="sc">*</span>(<span class="fu">sd</span>(lnrec)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="dv">2</span>)),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">ASD =</span> <span class="fu">sd</span>(ecdata),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">GM =</span> <span class="fu">geoMean</span>(ecdata),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">GSD =</span> <span class="fu">geoSD</span>(ecdata),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(job, facilityid, <span class="fu">desc</span>(AM))</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># show tibble</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>DEMSsummary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 18 × 8
     job facilityid     N    AM AM_mle   ASD    GM   GSD
   &lt;int&gt; &lt;chr&gt;      &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
 1   110 B              1 233.    NA    NA   233.  NA   
 2   110 D             11  55.1   55.1  24.9  50.4  1.56
 3   110 I             32  54.2   66.7  24.4  42.8  2.61
 4   240 A             15 372.   373.   88.5 361.   1.29
 5   240 B             33 290.  1569.  232.   97.9 10.9 
 6   240 E             10  90.2  126.   50.5  63.8  3.41
 7   240 G             36  45.8   46.3  37.5  35.9  2.06
 8   240 H             13 116.   160.   96.2  66.0  3.99
 9   410 B              7 137.   137.   61.1 125.   1.57
10   410 D             26  54.0   60.0  34.0  41.2  2.42
11   410 E             20  49.0   50.7  39.4  34.4  2.46
12   410 G             47  31.2   31.9  37.6  18.9  2.8 
13   410 I             46  69.6   97.4  46.7  44.1  3.57
14   600 B              4 120.   117.   92.2  98.9  1.97
15   600 D              2 102.   102.   43.9  96.7  1.56
16   600 E             11  83.4   87.7  54.1  63.9  2.3 
17   600 H             16  76.1  101.   71.5  42.0  3.92
18   600 I             10  55.8   56.4  33.6  47.1  1.88</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># print summary using kable</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(DEMSsummary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">job</th>
<th style="text-align: left;">facilityid</th>
<th style="text-align: right;">N</th>
<th style="text-align: right;">AM</th>
<th style="text-align: right;">AM_mle</th>
<th style="text-align: right;">ASD</th>
<th style="text-align: right;">GM</th>
<th style="text-align: right;">GSD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">110</td>
<td style="text-align: left;">B</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">233.28</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">233.28</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: right;">110</td>
<td style="text-align: left;">D</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">55.09</td>
<td style="text-align: right;">55.10</td>
<td style="text-align: right;">24.93</td>
<td style="text-align: right;">50.42</td>
<td style="text-align: right;">1.56</td>
</tr>
<tr class="odd">
<td style="text-align: right;">110</td>
<td style="text-align: left;">I</td>
<td style="text-align: right;">32</td>
<td style="text-align: right;">54.21</td>
<td style="text-align: right;">66.74</td>
<td style="text-align: right;">24.39</td>
<td style="text-align: right;">42.79</td>
<td style="text-align: right;">2.61</td>
</tr>
<tr class="even">
<td style="text-align: right;">240</td>
<td style="text-align: left;">A</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">372.12</td>
<td style="text-align: right;">372.74</td>
<td style="text-align: right;">88.48</td>
<td style="text-align: right;">361.45</td>
<td style="text-align: right;">1.29</td>
</tr>
<tr class="odd">
<td style="text-align: right;">240</td>
<td style="text-align: left;">B</td>
<td style="text-align: right;">33</td>
<td style="text-align: right;">289.58</td>
<td style="text-align: right;">1569.35</td>
<td style="text-align: right;">231.89</td>
<td style="text-align: right;">97.94</td>
<td style="text-align: right;">10.94</td>
</tr>
<tr class="even">
<td style="text-align: right;">240</td>
<td style="text-align: left;">E</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">90.18</td>
<td style="text-align: right;">125.68</td>
<td style="text-align: right;">50.51</td>
<td style="text-align: right;">63.76</td>
<td style="text-align: right;">3.41</td>
</tr>
<tr class="odd">
<td style="text-align: right;">240</td>
<td style="text-align: left;">G</td>
<td style="text-align: right;">36</td>
<td style="text-align: right;">45.75</td>
<td style="text-align: right;">46.32</td>
<td style="text-align: right;">37.50</td>
<td style="text-align: right;">35.92</td>
<td style="text-align: right;">2.06</td>
</tr>
<tr class="even">
<td style="text-align: right;">240</td>
<td style="text-align: left;">H</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">115.98</td>
<td style="text-align: right;">159.51</td>
<td style="text-align: right;">96.22</td>
<td style="text-align: right;">66.01</td>
<td style="text-align: right;">3.99</td>
</tr>
<tr class="odd">
<td style="text-align: right;">410</td>
<td style="text-align: left;">B</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">136.78</td>
<td style="text-align: right;">136.96</td>
<td style="text-align: right;">61.09</td>
<td style="text-align: right;">125.41</td>
<td style="text-align: right;">1.57</td>
</tr>
<tr class="even">
<td style="text-align: right;">410</td>
<td style="text-align: left;">D</td>
<td style="text-align: right;">26</td>
<td style="text-align: right;">53.99</td>
<td style="text-align: right;">60.01</td>
<td style="text-align: right;">34.05</td>
<td style="text-align: right;">41.24</td>
<td style="text-align: right;">2.42</td>
</tr>
<tr class="odd">
<td style="text-align: right;">410</td>
<td style="text-align: left;">E</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">49.03</td>
<td style="text-align: right;">50.66</td>
<td style="text-align: right;">39.39</td>
<td style="text-align: right;">34.42</td>
<td style="text-align: right;">2.46</td>
</tr>
<tr class="even">
<td style="text-align: right;">410</td>
<td style="text-align: left;">G</td>
<td style="text-align: right;">47</td>
<td style="text-align: right;">31.25</td>
<td style="text-align: right;">31.86</td>
<td style="text-align: right;">37.63</td>
<td style="text-align: right;">18.94</td>
<td style="text-align: right;">2.80</td>
</tr>
<tr class="odd">
<td style="text-align: right;">410</td>
<td style="text-align: left;">I</td>
<td style="text-align: right;">46</td>
<td style="text-align: right;">69.56</td>
<td style="text-align: right;">97.36</td>
<td style="text-align: right;">46.72</td>
<td style="text-align: right;">44.12</td>
<td style="text-align: right;">3.57</td>
</tr>
<tr class="even">
<td style="text-align: right;">600</td>
<td style="text-align: left;">B</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">119.52</td>
<td style="text-align: right;">117.44</td>
<td style="text-align: right;">92.15</td>
<td style="text-align: right;">98.88</td>
<td style="text-align: right;">1.97</td>
</tr>
<tr class="odd">
<td style="text-align: right;">600</td>
<td style="text-align: left;">D</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">101.60</td>
<td style="text-align: right;">101.68</td>
<td style="text-align: right;">43.94</td>
<td style="text-align: right;">96.73</td>
<td style="text-align: right;">1.56</td>
</tr>
<tr class="even">
<td style="text-align: right;">600</td>
<td style="text-align: left;">E</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">83.39</td>
<td style="text-align: right;">87.72</td>
<td style="text-align: right;">54.08</td>
<td style="text-align: right;">63.93</td>
<td style="text-align: right;">2.30</td>
</tr>
<tr class="odd">
<td style="text-align: right;">600</td>
<td style="text-align: left;">H</td>
<td style="text-align: right;">16</td>
<td style="text-align: right;">76.14</td>
<td style="text-align: right;">100.65</td>
<td style="text-align: right;">71.49</td>
<td style="text-align: right;">42.02</td>
<td style="text-align: right;">3.92</td>
</tr>
<tr class="even">
<td style="text-align: right;">600</td>
<td style="text-align: left;">I</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">55.83</td>
<td style="text-align: right;">56.41</td>
<td style="text-align: right;">33.56</td>
<td style="text-align: right;">47.12</td>
<td style="text-align: right;">1.88</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="visualize-the-data-and-understand-its-distribution-graphically" class="level2">
<h2 class="anchored" data-anchor-id="visualize-the-data-and-understand-its-distribution-graphically">Visualize the data and understand its distribution graphically</h2>
<p>Here are some sample graphical commands: (Plots in this section are not run; histogram code is modified from Week 1 lab, though now with new data and better labeling.)</p>
<section id="histograms" class="level3">
<h3 class="anchored" data-anchor-id="histograms">Histograms</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----hist in tidyverse----</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># first define the basic plot using the density scale</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> DEMSu, <span class="fu">aes</span>(lnrec)) <span class="sc">+</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">colour =</span> <span class="st">"black"</span>, </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                   <span class="at">fill =</span> <span class="st">"white"</span>, </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                   <span class="at">binwidth =</span> <span class="fl">0.5</span> </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># create dataframe to overlay a normal density curve:</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>norm_df <span class="ot">&lt;-</span> <span class="fu">with</span>(DEMSu <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>(lnrec), </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>           <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="fu">min</span>(lnrec), <span class="fu">max</span>(lnrec), <span class="at">length.out =</span> <span class="fu">length</span>(lnrec) ), </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> <span class="fu">dnorm</span>(x, <span class="fu">mean</span>(lnrec), <span class="fu">sd</span>(lnrec)) ) </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co"># histogram + overlaid normal + density w/ transparency</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> norm_df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y), <span class="at">color =</span> <span class="st">"red"</span>)  <span class="sc">+</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">alpha =</span> .<span class="dv">2</span>, <span class="at">fill =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Density Plot of ln(REC)</span><span class="sc">\n</span><span class="st">"</span>,<span class="st">"In 4 Underground Jobs"</span>), </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">caption =</span> <span class="fu">paste</span>(<span class="st">"With overlaid normal distribution (red line) with the same mean and SD"</span>), </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"ln(REC) (ln(ug/m^3)"</span>) <span class="sc">+</span> </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="q-q-plots-normal-probability-plots" class="level3">
<h3 class="anchored" data-anchor-id="q-q-plots-normal-probability-plots">Q-Q plots (Normal probability plots)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----qqplot in tidyverse----</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># create the base plot, overlay the points and line, and add title</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(DEMSu, <span class="fu">aes</span>(<span class="at">sample =</span> lnrec)) <span class="sc">+</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_qq</span>() <span class="sc">+</span> <span class="fu">stat_qq_line</span>() <span class="sc">+</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Normal Q-Q Plot of ln(REC)</span><span class="sc">\n</span><span class="st">In 4 Underground Jobs"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># show plot</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="test-the-normality-of-a-variable" class="level2">
<h2 class="anchored" data-anchor-id="test-the-normality-of-a-variable">Test the normality of a variable</h2>
<p>The Shapiro-Wilk test evaluates the null hypothesis that the data are normally distributed against the alternative that they aren’t. Unfortunately, it is very easy to reject the null hypothesis using this test, particularly when the sample size is large. See <a href="http://emilkirkegaard.dk/en/?p=4452">this example using simulations</a> to get a feeling for the kinds of deviations from normality that give high and statistically significant Shapiro-Wilk tests. The general advice in using this test is to not over-interpret it. Look at the data visually and use your judgment about whether they are consistent with a normal distribution. Ask yourself whether it is just a few values at the tails that deviate, or are there other more important concerns.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----Shapiro-Wilk test----</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#for normality of a variable</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(DEMSu<span class="sc">$</span>lnrec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    Shapiro-Wilk normality test

data:  DEMSu$lnrec
W = 0.95703, p-value = 1.997e-08</code></pre>
</div>
</div>
</section>
<section id="take-a-random-sample-of-data-in-memory" class="level2">
<h2 class="anchored" data-anchor-id="take-a-random-sample-of-data-in-memory">Take a random sample of data in memory</h2>
<ul>
<li><code>small&lt;-sample(DEMSu$lnrec,10)</code> gives a sample of size 10 of the data</li>
<li><code>half&lt;- sample(DEMSu$lnrec,size=length(DEMSu$lnrec)/2,replace=TRUE)</code> gives a 50% sample of the data with replacement</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----samples----</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># recall you want to set the seed to make your work reproducible</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">502</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the sample command takes from the vector of data (the first argument), a</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># sample of size given by the argument.  The default is to sample without</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># replacement, so you need to set replace=TRUE if you want sampling with</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># replacement.</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>small <span class="ot">&lt;-</span> <span class="fu">sample</span>(DEMSu<span class="sc">$</span>lnrec, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>half <span class="ot">&lt;-</span> <span class="fu">sample</span>(DEMSu<span class="sc">$</span>lnrec,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="fu">length</span>(DEMSu<span class="sc">$</span>lnrec) <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">replace =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculate-the-exceedance-fraction-and-related-statistics" class="level2">
<h2 class="anchored" data-anchor-id="calculate-the-exceedance-fraction-and-related-statistics">Calculate the exceedance fraction and related statistics</h2>
<p>Here we get the empiric exceedance fraction, the parametric exceedance probability and show the tools for estimating various confidence limits for percentiles. For these calculations, we’ll assume an OEL for REC equal to 200 <span class="math inline">\(\mu g/m^3\)</span>.</p>
<ul>
<li><strong>Empiric exceedance fraction</strong>:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----emp exc frac----</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(DEMSu<span class="sc">$</span>ecdata <span class="sc">&gt;</span> <span class="dv">200</span>) <span class="sc">/</span> <span class="fu">length</span>(DEMSu<span class="sc">$</span>ecdata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1235294</code></pre>
</div>
</div>
<ul>
<li><strong>Parametric exceedance fraction</strong>:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----param exc frac----</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(<span class="dv">200</span>) <span class="sc">-</span> <span class="fu">mean</span>(DEMSu<span class="sc">$</span>lnrec)) <span class="sc">/</span> <span class="fu">sd</span>(DEMSu<span class="sc">$</span>lnrec))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1444723</code></pre>
</div>
</div>
<ul>
<li><strong>Upper 5<sup>th</sup> percentile of the distribution and its 70% CI</strong>. The following describes an approach estimated directly on the log-transformed data and exponentiates. You can use the <code>quantileCI</code> command in the <code>MKmisc</code> package. (See https://rdrr.io.) The <code>quantile</code> command in base R can be used to get the upper 5th percentile (or 95th percentile), but there is no clear way to get its CI from the <code>quantile</code> command.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----quantile 95+70th CI----</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the quantile command:</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 95th percentile quantile on log scale</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(DEMSu<span class="sc">$</span>lnrec, .<span class="dv">95</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     95% 
5.993057 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 95th percentile quantile on native scale</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">quantile</span>(DEMSu<span class="sc">$</span>lnrec, .<span class="dv">95</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     95% 
400.6374 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># now using quantileCI:</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">quantileCI</span>(DEMSu<span class="sc">$</span>lnrec, <span class="at">prob =</span> <span class="fl">0.95</span>, <span class="at">conf.level =</span> <span class="fl">0.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    exact confidence interval

70.31505 percent confidence interval:
                 lower    upper
95 % quantile 5.855116 6.007254

sample estimate:
95 % quantile 
     5.993057 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantileCI</span>(DEMSu<span class="sc">$</span>ecdata, <span class="at">prob =</span> <span class="fl">0.95</span>, <span class="at">conf.level =</span> <span class="fl">0.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
    exact confidence interval

70.31505 percent confidence interval:
                 lower    upper
95 % quantile 349.0152 406.3658

sample estimate:
95 % quantile 
     400.6375 </code></pre>
</div>
</div>
</section>
<section id="log-probability-plots" class="level2">
<h2 class="anchored" data-anchor-id="log-probability-plots">Log probability plots</h2>
<p>These plots have the value of the exposure variable on the native scale (e.g.&nbsp;concentration, not transformed) on the x axis displayed on the log base 10 scale, and the corresponding normal probability for the cumulative distribution on the y axis. The following code generates some lognormal data and then plots them using this framework. To implement this with the DEMS data, you will need to address specifics in the example, such as locations of the tick lines and range of the data.</p>
<p>Notes on how to create this:</p>
<ol type="1">
<li><p>Focus on x, our exposure variable of interest, which is typically assumed to be lognormally distributed</p></li>
<li><p>Transform data to the log scale (<span class="math inline">\(y=ln(x)\)</span>)</p></li>
<li><p>Generate order statistics (<span class="math inline">\(p_i=order/N+1\)</span>)</p></li>
<li><p>Convert these order statistics to standard normal quantiles with the same mean and SD as y.</p></li>
<li><p>Exponentiate the normal quantile variable so it is comparable with x.</p></li>
<li><p>Plot the theoretical quantiles (exponentiated quantiles) vs the input data x (data on the x axis; theoretical quantiles on the y axis).</p></li>
<li><p>Plot labels on y axis shows the corresponding normal probabilities rather than the theoretical quantiles. Both axes scale to the log base 10 scale.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----generate data for log probability plot example----</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set seed for reproducibility</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2001</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the measurement x ~LN(mu_y,sd_y) and y=log(x) ~N(mu_y,sd_y)</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># generate a random lognormal, with specified mean and sd as from lecture</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co"># eventually we can replace this example with measured data</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># x is the "measured" exposure data ~LN</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rlnorm</span>(<span class="at">n =</span> <span class="dv">1000</span>, <span class="at">meanlog =</span> <span class="dv">1</span>, <span class="at">sdlog =</span> <span class="fl">0.92</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># variable y is normally distributed </span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co"># for exposure data this is ordinarily the log-transformed measurement</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">log</span>(x)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Use rank to get the order statistics </span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>rx <span class="ot">&lt;-</span> <span class="fu">rank</span>(x)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a><span class="co"># order statistics re-expressed as proportions</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>p_i <span class="ot">&lt;-</span> rx<span class="sc">/</span>(<span class="fu">length</span>(x)<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co"># corresponding normal quantiles for a distribution with realized mean and</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="co"># variance of y.  Need to use these later for the y axis probabilities.</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="co"># (Surrounding parentheses print these in the output if echo=TRUE)</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>(y_bar <span class="ot">&lt;-</span> <span class="fu">mean</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9972311</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>(sd_y <span class="ot">&lt;-</span> <span class="fu">sd</span>(y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9079101</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># theoretical quantiles of the normal distribution that corresponds to the data</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="co"># on the log scale</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>qy <span class="ot">&lt;-</span><span class="fu">qnorm</span>(p_i)<span class="sc">*</span>sd_y<span class="sc">+</span>y_bar</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">#quantiles of the corresponding LN distribution</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>qx <span class="ot">&lt;-</span> <span class="fu">exp</span>(qy)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># create a data frame for plotting</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>pplot_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(y, x, rx, p_i, qy, qx)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co"># some summary statistics to check while developing this (commented out)</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(y)</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"GM:  "</span>, <span class="fu">exp</span>(y_bar))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "GM:   2.71076550339916"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"GSD:  "</span>,<span class="fu">exp</span>(<span class="fu">sd</span>(y)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "GSD:   2.47913603587329"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"AM:  "</span>, <span class="fu">exp</span>(y_bar<span class="sc">+</span>((<span class="fu">length</span>(y)<span class="sc">-</span><span class="dv">1</span>)<span class="sc">/</span><span class="fu">length</span>(y))<span class="sc">*</span>sd_y<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "AM:   4.09173594894308"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(x)</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co">#sd(x)</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># now generate the data for the y axis -- need to create a vector of probabilities</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"># that we wish to display:</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>probs <span class="ot">&lt;-</span> <span class="fu">c</span>(.<span class="dv">01</span>, .<span class="dv">02</span>, .<span class="dv">05</span>, .<span class="dv">1</span>, .<span class="dv">16</span>, .<span class="dv">25</span>, .<span class="dv">5</span>, .<span class="dv">75</span>, .<span class="dv">84</span>, .<span class="dv">9</span>, .<span class="dv">95</span>, .<span class="dv">98</span>, .<span class="dv">99</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co"># get the corresponding quantiles for the normal distribution with the same mean and variance</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>quants <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(probs, <span class="at">mean =</span> y_bar, <span class="at">sd =</span> sd_y)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co"># exponentiate these for plotting</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>exp_quants <span class="ot">&lt;-</span> <span class="fu">exp</span>(quants)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co"># in the plots we will draw horizontal lines at exp_quants and label these lines with the probs</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----log probability plot----</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Shows percentiles of the cumulative normal on the y axis; </span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># axes on the log base 10 scale;</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># coord_fixed assumes both axes are the same scaling (i.e. the aspect ratio for</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co"># x, qx is the same);</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co"># annotation_logticks puts in minor ticks in right scaling</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># minor_breaks addresses the unlabeled grid lines</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> pplot_data) <span class="sc">+</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(x,qx), <span class="at">shape =</span> <span class="st">"o"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(qx,qx)) <span class="sc">+</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotation_logticks</span>(<span class="at">sides=</span><span class="st">"b"</span>) <span class="sc">+</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_log10</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">50</span>),</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>                  <span class="at">limits=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="dv">50</span>),</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>                  <span class="at">minor_breaks=</span><span class="fu">c</span>(<span class="fl">0.2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">20</span>) ) <span class="sc">+</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_log10</span>(<span class="at">breaks=</span>exp_quants,</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">labels=</span>probs,</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">limits=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="dv">50</span>),</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">minor_breaks=</span><span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Sample log probability plot</span><span class="sc">\n</span><span class="st">Using simulated data"</span>,</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Concentration (native scale units)"</span>,</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">y=</span> <span class="st">"% of data less than"</span>) <span class="sc">+</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Week2Lab_files/figure-html/log%20probability%20plot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="practice-session" class="level1">
<h1>Practice Session</h1>
<ol type="1">
<li>Plan to use an R project for this lab and make sure it is set up. You probably will want to use one project for the entire ENVH556 course.</li>
<li>Read in the ‘DEMSCombinedPersonal’ R dataset and keep only measurements from jobs 110, 240, 410 and 600 among underground workers. (We have selected these particular jobs for simplicity, but feel free to explore additional jobs or other categories of the data if you want to.) In order to avoid potential confusion later, for this practice session we suggest you also drop any observations that are missing <code>ecdata</code>.</li>
<li>Describe REC (varname: <code>ecdata</code>)</li>
<li>Determine whether REC in this subset is lognormally distributed. Explore using histograms, qqplots, and statistical tests.</li>
<li>Calculate the GM, GSD, and AM (using both method of moments and maximum likelihood estimates for the AM) for each group.</li>
<li>For a selected group (i.e.&nbsp;a single job, or for all four if you want): Assume data are lognormal (LN) and an OEL of 200 <span class="math inline">\(\mu g/m^3\)</span> has been determined for REC.
<ol type="a">
<li><p>Calculate the empiric and parametric exceedance probabilities along with the 95<sup>th</sup> percentile and 70% confidence limits.</p></li>
<li><p>Take a random sample of 50%, 25%, n=9 and n=5 samples and recalculate the GM, GSD, 95<sup>th</sup> percentile <span class="math inline">\(\pm\)</span> 70% confidence limits.</p></li>
</ol></li>
</ol>
</section>
<section id="homework-exercises" class="level1">
<h1>Homework Exercises</h1>
<ol type="1">
<li>Consider the primary exposure measures of interest to the study, including REC, NO_2 and organic carbon. Choose either the full dataset or a reduced subset, such as the four selected underground jobs. (Justify your choice as part of your lab write-up.)
<ol type="a">
<li>Describe the distribution, out of range and/or missing values for these exposure measures.</li>
<li>Determine the adequacy of the LN distribution for representing these using distribution plots and/or statistical tests.<br>
</li>
</ol></li>
<li>Explore potential stratification variables (determinants such as facility, job, location).
<ol type="a">
<li>Do the stratified data improve the distributional characteristics? Does it matter whether you restrict your attention to smaller subgroups of the data, e.g., underground only, specific facilities, specific jobs, or a combination of these?</li>
</ol></li>
<li>Calculate the GM, median, AM (method of moments) and AM (maximum likelihood) for REC.
<ol type="a">
<li>How do these quantities compare to each other?</li>
<li>Can you determine any characteristics of the data which help explain the differences between these alternative measures of central tendency?</li>
<li>For at least one stratum that has data that aren’t too far off from a lognormal distribution, plot the log probability plot. Read off the GM and GSD from the log probability plot and compare these to values you estimate directly from the data.</li>
</ol></li>
<li>Assuming an OEL for REC of 200 <span class="math inline">\(\mu g/m^3\)</span>, calculate the exceedance probability for each mine (and/or job) using both empiric and parametric approaches. In addition, calculate the 95<sup>th</sup> percentile of the distribution, and provide 70% confidence limits on these percentiles.
<ol type="a">
<li>What are the differences between the empiric and parametric methods of calculation?</li>
</ol></li>
<li>Take random samples of the data (e.g., 50%, 10%, n=9, n=5) and recalculate the various summary statistics.
<ol type="a">
<li>How does the reduced sample size affect the estimates? Explain.</li>
</ol></li>
</ol>
</section>
<section id="appendix-1-older-base-r-versions-for-reference" class="level1 unnumbered">
<h1 class="unnumbered">Appendix 1: Older Base R versions for reference</h1>
<section id="a1.1-q-q-plot" class="level2 unnumbered">
<h2 class="unnumbered anchored" data-anchor-id="a1.1-q-q-plot">A1.1 Q-Q plot</h2>
<p>For a q-q plot to determine whether the data are normally distributed, use <code>qqnorm()</code> and you can overlay <code>qqline()</code>. There is code in the <code>.Rmd</code> file if you wish to use it.</p>
</section>
</section>
<section id="appendix-2-code-session-information-and-functions" class="level1 unnumbered">
<h1 class="unnumbered">Appendix 2: Code, session information, and functions</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----session information----</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="co"># print R session information</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.3.1 (2023-06-16)
Platform: aarch64-apple-darwin20 (64-bit)
Running under: macOS Sonoma 14.6.1

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.3-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.11.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Los_Angeles
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] MKmisc_1.9     EnvStats_3.0.0 Hmisc_5.1-3    ggplot2_3.5.1  purrr_1.0.2   
[6] knitr_1.48     tidyr_1.3.1    dplyr_1.1.4    pacman_0.5.1  

loaded via a namespace (and not attached):
 [1] utf8_1.2.4          generics_0.1.3      robustbase_0.99-4  
 [4] stringi_1.8.4       digest_0.6.37       magrittr_2.0.3     
 [7] RColorBrewer_1.1-3  evaluate_1.0.0      grid_4.3.1         
[10] fastmap_1.2.0       jsonlite_1.8.9      nnet_7.3-19        
[13] backports_1.5.0     limma_3.58.1        Formula_1.2-5      
[16] gridExtra_2.3       BiocManager_1.30.25 fansi_1.0.6        
[19] scales_1.3.0        cli_3.6.3           rlang_1.1.4        
[22] munsell_0.5.1       base64enc_0.1-3     withr_3.0.1        
[25] yaml_2.3.10         tools_4.3.1         checkmate_2.3.2    
[28] htmlTable_2.4.3     colorspace_2.1-1    vctrs_0.6.5        
[31] R6_2.5.1            rpart_4.1.23        lifecycle_1.0.4    
[34] stringr_1.5.1       htmlwidgets_1.6.4   foreign_0.8-87     
[37] cluster_2.1.6       pkgconfig_2.0.3     pillar_1.9.0       
[40] gtable_0.3.5        glue_1.7.0          data.table_1.16.0  
[43] statmod_1.5.0       DEoptimR_1.1-3      xfun_0.47          
[46] tibble_3.2.1        tidyselect_1.2.1    rstudioapi_0.16.0  
[49] farver_2.1.2        htmltools_0.5.8.1   rmarkdown_2.28     
[52] compiler_4.3.1     </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----clear workspace----</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># code to clear the environment without clearing knitr. Useful for code</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># development because it simulates the knitr environment Run as a code chunk</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># when testing.  When knitr is run, this is effectively run in the knitr</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="co"># environment</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Clear workspace of all objects and unload all extra (non-base) packages</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>(<span class="at">all =</span> <span class="cn">TRUE</span>))</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(<span class="fu">sessionInfo</span>()<span class="sc">$</span>otherPkgs)) {</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">lapply</span>(</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste</span>(<span class="st">'package:'</span>, <span class="fu">names</span>(<span class="fu">sessionInfo</span>()<span class="sc">$</span>otherPkgs), <span class="at">sep =</span> <span class="st">""</span>),</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>        detach,</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">character.only =</span> <span class="cn">TRUE</span>,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">unload =</span> <span class="cn">TRUE</span>,</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">force =</span> <span class="cn">TRUE</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="co">#-----load packages----</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="co"># To address a dependency issue, one package (`limma`) must be installed through</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="co"># another package (`BiocManager`)</span></span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"BiocManager"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>))</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"BiocManager"</span>)</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"limma"</span>)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a><span class="co"># For the remaining packages, load pacman, installing as needed</span></span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>my_repo <span class="ot">&lt;-</span> <span class="st">'http://cran.r-project.org'</span></span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) {<span class="fu">install.packages</span>(<span class="st">"pacman"</span>, <span class="at">repos =</span> my_repo)}</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the other packages, installing as needed.  Some reasons for packages:</span></span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a><span class="co"># knitr:  kable</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a><span class="co"># dplyr: data wrangling functions.</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a><span class="co"># tidyr: drop_na</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot: visualizations</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Hmisc:  describe</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a><span class="co"># EnvStats: geoMean, geoSD, probability plotting functions</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a><span class="co"># MKmisc:  quantileCI</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(dplyr, tidyr, knitr, purrr, ggplot2, Hmisc, EnvStats, MKmisc)</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a><span class="co"># download_and_read_file() function etc.</span></span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"global_functions.R"</span>)</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a><span class="co">#-----read data----</span></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a><span class="co"># create data directory if it does not exist</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="fu">file.path</span>(<span class="st">"Datasets"</span>),</span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>           <span class="at">showWarnings =</span> <span class="cn">FALSE</span>,</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>           <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a><span class="co"># assign data_path variable</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>data_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"Datasets"</span>)</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a><span class="co"># read data; download if necessary</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>DEMS <span class="ot">&lt;-</span> <span class="fu">download_and_read_file</span>(<span class="at">data_url =</span> <span class="st">"https://faculty.washington.edu/sheppard/envh556/Datasets/DEMSCombinedPersonal.rds"</span>, </span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">output_file_path =</span> <span class="fu">file.path</span>(data_path, <span class="st">"DEMSCombinedPersonal.rds"</span>))</span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>           </span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a><span class="co">#-----create tibble----</span></span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>DEMS <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(DEMS)</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a><span class="co">#-----filter data----</span></span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a><span class="co"># filter dataset to keep underground only; 4 jobs codes: 240,110,410,600; and </span></span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a><span class="co"># non-missing ecdata. </span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>DEMSu <span class="ot">&lt;-</span> <span class="fu">filter</span>(DEMS, </span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>                u_s <span class="sc">==</span> <span class="st">"u"</span>, </span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>                job <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">240</span>, <span class="dv">110</span>, <span class="dv">410</span>, <span class="dv">600</span>), </span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>                <span class="sc">!</span><span class="fu">is.na</span>(ecdata) )</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a><span class="co">#-----transform vars----</span></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a><span class="co"># The natural log and log base 10 transformations of ecdata will be added to the </span></span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a><span class="co"># DEMSu tibble:</span></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>DEMSu <span class="ot">&lt;-</span> <span class="fu">mutate</span>(DEMSu,</span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>                <span class="at">lnrec =</span> <span class="fu">log</span>(ecdata),</span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>                <span class="at">log10rec =</span> <span class="fu">log10</span>(ecdata) )</span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a><span class="co">#-----table with dplyr----</span></span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a><span class="co"># create summary </span></span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a><span class="co"># note: "summarize()" will call a different function from the Hmisc package</span></span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a>DEMSsummary <span class="ot">&lt;-</span> DEMSu <span class="sc">%&gt;%</span> </span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(job,facilityid) <span class="sc">%&gt;%</span></span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">N =</span> <span class="fu">n</span>(),</span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>              <span class="at">AM =</span> <span class="fu">mean</span>(ecdata),</span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>              <span class="at">AM_mle =</span> (<span class="fu">exp</span>(<span class="fu">mean</span>(lnrec)<span class="sc">+</span>((N<span class="dv">-1</span>)<span class="sc">/</span>N)<span class="sc">*</span>(<span class="fu">sd</span>(lnrec)<span class="sc">^</span><span class="dv">2</span>)<span class="sc">/</span><span class="dv">2</span>)),</span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>              <span class="at">ASD =</span> <span class="fu">sd</span>(ecdata),</span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>              <span class="at">GM =</span> <span class="fu">geoMean</span>(ecdata),</span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>              <span class="at">GSD =</span> <span class="fu">geoSD</span>(ecdata),</span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate_if</span>(is.double, round, <span class="at">digits =</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(job, facilityid, <span class="fu">desc</span>(AM))</span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a><span class="co"># show tibble</span></span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>DEMSsummary</span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a><span class="co"># print summary using kable</span></span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(DEMSsummary)</span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a><span class="co">#-----hist in tidyverse----</span></span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a><span class="co"># first define the basic plot using the density scale</span></span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> DEMSu, <span class="fu">aes</span>(lnrec)) <span class="sc">+</span></span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a>                   <span class="at">colour =</span> <span class="st">"black"</span>, </span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>                   <span class="at">fill =</span> <span class="st">"white"</span>, </span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>                   <span class="at">binwidth =</span> <span class="fl">0.5</span> </span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a><span class="co"># create dataframe to overlay a normal density curve:</span></span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>norm_df <span class="ot">&lt;-</span> <span class="fu">with</span>(DEMSu <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>(lnrec), </span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a>           <span class="fu">tibble</span>(<span class="at">x =</span> <span class="fu">seq</span>(<span class="fu">min</span>(lnrec), <span class="fu">max</span>(lnrec), <span class="at">length.out =</span> <span class="fu">length</span>(lnrec) ), </span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> <span class="fu">dnorm</span>(x, <span class="fu">mean</span>(lnrec), <span class="fu">sd</span>(lnrec)) ) </span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>           )</span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a><span class="co"># histogram + overlaid normal + density w/ transparency</span></span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span></span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> norm_df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y), <span class="at">color =</span> <span class="st">"red"</span>)  <span class="sc">+</span></span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">alpha =</span> .<span class="dv">2</span>, <span class="at">fill =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Density Plot of ln(REC)</span><span class="sc">\n</span><span class="st">"</span>,<span class="st">"In 4 Underground Jobs"</span>), </span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a>         <span class="at">caption =</span> <span class="fu">paste</span>(<span class="st">"With overlaid normal distribution (red line) with the same mean and SD"</span>), </span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"ln(REC) (ln(ug/m^3)"</span>) <span class="sc">+</span> </span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">expand =</span> <span class="fu">expansion</span>(<span class="at">mult =</span> <span class="fu">c</span>(<span class="dv">0</span>, .<span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="dv">0</span>))</span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a><span class="co">#-----qqplot in tidyverse----</span></span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a><span class="co"># create the base plot, overlay the points and line, and add title</span></span>
<span id="cb38-131"><a href="#cb38-131" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(DEMSu, <span class="fu">aes</span>(<span class="at">sample =</span> lnrec)) <span class="sc">+</span></span>
<span id="cb38-132"><a href="#cb38-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_qq</span>() <span class="sc">+</span> <span class="fu">stat_qq_line</span>() <span class="sc">+</span></span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Normal Q-Q Plot of ln(REC)</span><span class="sc">\n</span><span class="st">In 4 Underground Jobs"</span>)</span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-135"><a href="#cb38-135" aria-hidden="true" tabindex="-1"></a><span class="co"># show plot</span></span>
<span id="cb38-136"><a href="#cb38-136" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb38-137"><a href="#cb38-137" aria-hidden="true" tabindex="-1"></a><span class="co">#-----Shapiro-Wilk test----</span></span>
<span id="cb38-138"><a href="#cb38-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-139"><a href="#cb38-139" aria-hidden="true" tabindex="-1"></a><span class="co">#for normality of a variable</span></span>
<span id="cb38-140"><a href="#cb38-140" aria-hidden="true" tabindex="-1"></a><span class="fu">shapiro.test</span>(DEMSu<span class="sc">$</span>lnrec)</span>
<span id="cb38-141"><a href="#cb38-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-142"><a href="#cb38-142" aria-hidden="true" tabindex="-1"></a><span class="co">#-----samples----</span></span>
<span id="cb38-143"><a href="#cb38-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-144"><a href="#cb38-144" aria-hidden="true" tabindex="-1"></a><span class="co"># recall you want to set the seed to make your work reproducible</span></span>
<span id="cb38-145"><a href="#cb38-145" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">502</span>)</span>
<span id="cb38-146"><a href="#cb38-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-147"><a href="#cb38-147" aria-hidden="true" tabindex="-1"></a><span class="co"># the sample command takes from the vector of data (the first argument), a</span></span>
<span id="cb38-148"><a href="#cb38-148" aria-hidden="true" tabindex="-1"></a><span class="co"># sample of size given by the argument.  The default is to sample without</span></span>
<span id="cb38-149"><a href="#cb38-149" aria-hidden="true" tabindex="-1"></a><span class="co"># replacement, so you need to set replace=TRUE if you want sampling with</span></span>
<span id="cb38-150"><a href="#cb38-150" aria-hidden="true" tabindex="-1"></a><span class="co"># replacement.</span></span>
<span id="cb38-151"><a href="#cb38-151" aria-hidden="true" tabindex="-1"></a>small <span class="ot">&lt;-</span> <span class="fu">sample</span>(DEMSu<span class="sc">$</span>lnrec, <span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb38-152"><a href="#cb38-152" aria-hidden="true" tabindex="-1"></a>half <span class="ot">&lt;-</span> <span class="fu">sample</span>(DEMSu<span class="sc">$</span>lnrec,</span>
<span id="cb38-153"><a href="#cb38-153" aria-hidden="true" tabindex="-1"></a>               <span class="at">size =</span> <span class="fu">length</span>(DEMSu<span class="sc">$</span>lnrec) <span class="sc">/</span> <span class="dv">2</span>,</span>
<span id="cb38-154"><a href="#cb38-154" aria-hidden="true" tabindex="-1"></a>               <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-155"><a href="#cb38-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-156"><a href="#cb38-156" aria-hidden="true" tabindex="-1"></a><span class="co">#-----emp exc frac----</span></span>
<span id="cb38-157"><a href="#cb38-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-158"><a href="#cb38-158" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(DEMSu<span class="sc">$</span>ecdata <span class="sc">&gt;</span> <span class="dv">200</span>) <span class="sc">/</span> <span class="fu">length</span>(DEMSu<span class="sc">$</span>ecdata)</span>
<span id="cb38-159"><a href="#cb38-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-160"><a href="#cb38-160" aria-hidden="true" tabindex="-1"></a><span class="co">#-----param exc frac----</span></span>
<span id="cb38-161"><a href="#cb38-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-162"><a href="#cb38-162" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>((<span class="fu">log</span>(<span class="dv">200</span>) <span class="sc">-</span> <span class="fu">mean</span>(DEMSu<span class="sc">$</span>lnrec)) <span class="sc">/</span> <span class="fu">sd</span>(DEMSu<span class="sc">$</span>lnrec))</span>
<span id="cb38-163"><a href="#cb38-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-164"><a href="#cb38-164" aria-hidden="true" tabindex="-1"></a><span class="co">#-----quantile 95+70th CI----</span></span>
<span id="cb38-165"><a href="#cb38-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-166"><a href="#cb38-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the quantile command:</span></span>
<span id="cb38-167"><a href="#cb38-167" aria-hidden="true" tabindex="-1"></a><span class="co"># 95th percentile quantile on log scale</span></span>
<span id="cb38-168"><a href="#cb38-168" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(DEMSu<span class="sc">$</span>lnrec, .<span class="dv">95</span>)</span>
<span id="cb38-169"><a href="#cb38-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-170"><a href="#cb38-170" aria-hidden="true" tabindex="-1"></a><span class="co"># 95th percentile quantile on native scale</span></span>
<span id="cb38-171"><a href="#cb38-171" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">quantile</span>(DEMSu<span class="sc">$</span>lnrec, .<span class="dv">95</span>))</span>
<span id="cb38-172"><a href="#cb38-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-173"><a href="#cb38-173" aria-hidden="true" tabindex="-1"></a><span class="co"># now using quantileCI:</span></span>
<span id="cb38-174"><a href="#cb38-174" aria-hidden="true" tabindex="-1"></a><span class="fu">quantileCI</span>(DEMSu<span class="sc">$</span>lnrec, <span class="at">prob =</span> <span class="fl">0.95</span>, <span class="at">conf.level =</span> <span class="fl">0.7</span>)</span>
<span id="cb38-175"><a href="#cb38-175" aria-hidden="true" tabindex="-1"></a><span class="fu">quantileCI</span>(DEMSu<span class="sc">$</span>ecdata, <span class="at">prob =</span> <span class="fl">0.95</span>, <span class="at">conf.level =</span> <span class="fl">0.7</span>)</span>
<span id="cb38-176"><a href="#cb38-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-177"><a href="#cb38-177" aria-hidden="true" tabindex="-1"></a><span class="co">#-----generate data for log probability plot example----</span></span>
<span id="cb38-178"><a href="#cb38-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-179"><a href="#cb38-179" aria-hidden="true" tabindex="-1"></a><span class="co"># set seed for reproducibility</span></span>
<span id="cb38-180"><a href="#cb38-180" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2001</span>)</span>
<span id="cb38-181"><a href="#cb38-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-182"><a href="#cb38-182" aria-hidden="true" tabindex="-1"></a><span class="co"># the measurement x ~LN(mu_y,sd_y) and y=log(x) ~N(mu_y,sd_y)</span></span>
<span id="cb38-183"><a href="#cb38-183" aria-hidden="true" tabindex="-1"></a><span class="co"># generate a random lognormal, with specified mean and sd as from lecture</span></span>
<span id="cb38-184"><a href="#cb38-184" aria-hidden="true" tabindex="-1"></a><span class="co"># eventually we can replace this example with measured data</span></span>
<span id="cb38-185"><a href="#cb38-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-186"><a href="#cb38-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-187"><a href="#cb38-187" aria-hidden="true" tabindex="-1"></a><span class="co"># x is the "measured" exposure data ~LN</span></span>
<span id="cb38-188"><a href="#cb38-188" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rlnorm</span>(<span class="at">n =</span> <span class="dv">1000</span>, <span class="at">meanlog =</span> <span class="dv">1</span>, <span class="at">sdlog =</span> <span class="fl">0.92</span>)</span>
<span id="cb38-189"><a href="#cb38-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-190"><a href="#cb38-190" aria-hidden="true" tabindex="-1"></a><span class="co"># variable y is normally distributed </span></span>
<span id="cb38-191"><a href="#cb38-191" aria-hidden="true" tabindex="-1"></a><span class="co"># for exposure data this is ordinarily the log-transformed measurement</span></span>
<span id="cb38-192"><a href="#cb38-192" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">log</span>(x)</span>
<span id="cb38-193"><a href="#cb38-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-194"><a href="#cb38-194" aria-hidden="true" tabindex="-1"></a><span class="co"># Use rank to get the order statistics </span></span>
<span id="cb38-195"><a href="#cb38-195" aria-hidden="true" tabindex="-1"></a>rx <span class="ot">&lt;-</span> <span class="fu">rank</span>(x)</span>
<span id="cb38-196"><a href="#cb38-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-197"><a href="#cb38-197" aria-hidden="true" tabindex="-1"></a><span class="co"># order statistics re-expressed as proportions</span></span>
<span id="cb38-198"><a href="#cb38-198" aria-hidden="true" tabindex="-1"></a>p_i <span class="ot">&lt;-</span> rx<span class="sc">/</span>(<span class="fu">length</span>(x)<span class="sc">+</span><span class="dv">1</span>)</span>
<span id="cb38-199"><a href="#cb38-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-200"><a href="#cb38-200" aria-hidden="true" tabindex="-1"></a><span class="co"># corresponding normal quantiles for a distribution with realized mean and</span></span>
<span id="cb38-201"><a href="#cb38-201" aria-hidden="true" tabindex="-1"></a><span class="co"># variance of y.  Need to use these later for the y axis probabilities.</span></span>
<span id="cb38-202"><a href="#cb38-202" aria-hidden="true" tabindex="-1"></a><span class="co"># (Surrounding parentheses print these in the output if echo=TRUE)</span></span>
<span id="cb38-203"><a href="#cb38-203" aria-hidden="true" tabindex="-1"></a>(y_bar <span class="ot">&lt;-</span> <span class="fu">mean</span>(y))</span>
<span id="cb38-204"><a href="#cb38-204" aria-hidden="true" tabindex="-1"></a>(sd_y <span class="ot">&lt;-</span> <span class="fu">sd</span>(y))</span>
<span id="cb38-205"><a href="#cb38-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-206"><a href="#cb38-206" aria-hidden="true" tabindex="-1"></a><span class="co"># theoretical quantiles of the normal distribution that corresponds to the data</span></span>
<span id="cb38-207"><a href="#cb38-207" aria-hidden="true" tabindex="-1"></a><span class="co"># on the log scale</span></span>
<span id="cb38-208"><a href="#cb38-208" aria-hidden="true" tabindex="-1"></a>qy <span class="ot">&lt;-</span><span class="fu">qnorm</span>(p_i)<span class="sc">*</span>sd_y<span class="sc">+</span>y_bar</span>
<span id="cb38-209"><a href="#cb38-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-210"><a href="#cb38-210" aria-hidden="true" tabindex="-1"></a><span class="co">#quantiles of the corresponding LN distribution</span></span>
<span id="cb38-211"><a href="#cb38-211" aria-hidden="true" tabindex="-1"></a>qx <span class="ot">&lt;-</span> <span class="fu">exp</span>(qy)</span>
<span id="cb38-212"><a href="#cb38-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-213"><a href="#cb38-213" aria-hidden="true" tabindex="-1"></a><span class="co"># create a data frame for plotting</span></span>
<span id="cb38-214"><a href="#cb38-214" aria-hidden="true" tabindex="-1"></a>pplot_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(y, x, rx, p_i, qy, qx)</span>
<span id="cb38-215"><a href="#cb38-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-216"><a href="#cb38-216" aria-hidden="true" tabindex="-1"></a><span class="co"># some summary statistics to check while developing this (commented out)</span></span>
<span id="cb38-217"><a href="#cb38-217" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(y)</span></span>
<span id="cb38-218"><a href="#cb38-218" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"GM:  "</span>, <span class="fu">exp</span>(y_bar))</span>
<span id="cb38-219"><a href="#cb38-219" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"GSD:  "</span>,<span class="fu">exp</span>(<span class="fu">sd</span>(y)))</span>
<span id="cb38-220"><a href="#cb38-220" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">"AM:  "</span>, <span class="fu">exp</span>(y_bar<span class="sc">+</span>((<span class="fu">length</span>(y)<span class="sc">-</span><span class="dv">1</span>)<span class="sc">/</span><span class="fu">length</span>(y))<span class="sc">*</span>sd_y<span class="sc">^</span><span class="dv">2</span><span class="sc">/</span><span class="dv">2</span>))</span>
<span id="cb38-221"><a href="#cb38-221" aria-hidden="true" tabindex="-1"></a><span class="co">#summary(x)</span></span>
<span id="cb38-222"><a href="#cb38-222" aria-hidden="true" tabindex="-1"></a><span class="co">#sd(x)</span></span>
<span id="cb38-223"><a href="#cb38-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-224"><a href="#cb38-224" aria-hidden="true" tabindex="-1"></a><span class="co"># now generate the data for the y axis -- need to create a vector of probabilities</span></span>
<span id="cb38-225"><a href="#cb38-225" aria-hidden="true" tabindex="-1"></a><span class="co"># that we wish to display:</span></span>
<span id="cb38-226"><a href="#cb38-226" aria-hidden="true" tabindex="-1"></a>probs <span class="ot">&lt;-</span> <span class="fu">c</span>(.<span class="dv">01</span>, .<span class="dv">02</span>, .<span class="dv">05</span>, .<span class="dv">1</span>, .<span class="dv">16</span>, .<span class="dv">25</span>, .<span class="dv">5</span>, .<span class="dv">75</span>, .<span class="dv">84</span>, .<span class="dv">9</span>, .<span class="dv">95</span>, .<span class="dv">98</span>, .<span class="dv">99</span>)</span>
<span id="cb38-227"><a href="#cb38-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-228"><a href="#cb38-228" aria-hidden="true" tabindex="-1"></a><span class="co"># get the corresponding quantiles for the normal distribution with the same mean and variance</span></span>
<span id="cb38-229"><a href="#cb38-229" aria-hidden="true" tabindex="-1"></a>quants <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(probs, <span class="at">mean =</span> y_bar, <span class="at">sd =</span> sd_y)</span>
<span id="cb38-230"><a href="#cb38-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-231"><a href="#cb38-231" aria-hidden="true" tabindex="-1"></a><span class="co"># exponentiate these for plotting</span></span>
<span id="cb38-232"><a href="#cb38-232" aria-hidden="true" tabindex="-1"></a>exp_quants <span class="ot">&lt;-</span> <span class="fu">exp</span>(quants)</span>
<span id="cb38-233"><a href="#cb38-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-234"><a href="#cb38-234" aria-hidden="true" tabindex="-1"></a><span class="co"># in the plots we will draw horizontal lines at exp_quants and label these lines with the probs</span></span>
<span id="cb38-235"><a href="#cb38-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-236"><a href="#cb38-236" aria-hidden="true" tabindex="-1"></a><span class="co">#-----log probability plot----</span></span>
<span id="cb38-237"><a href="#cb38-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-238"><a href="#cb38-238" aria-hidden="true" tabindex="-1"></a><span class="co"># Shows percentiles of the cumulative normal on the y axis; </span></span>
<span id="cb38-239"><a href="#cb38-239" aria-hidden="true" tabindex="-1"></a><span class="co"># axes on the log base 10 scale;</span></span>
<span id="cb38-240"><a href="#cb38-240" aria-hidden="true" tabindex="-1"></a><span class="co"># coord_fixed assumes both axes are the same scaling (i.e. the aspect ratio for</span></span>
<span id="cb38-241"><a href="#cb38-241" aria-hidden="true" tabindex="-1"></a><span class="co"># x, qx is the same);</span></span>
<span id="cb38-242"><a href="#cb38-242" aria-hidden="true" tabindex="-1"></a><span class="co"># annotation_logticks puts in minor ticks in right scaling</span></span>
<span id="cb38-243"><a href="#cb38-243" aria-hidden="true" tabindex="-1"></a><span class="co"># minor_breaks addresses the unlabeled grid lines</span></span>
<span id="cb38-244"><a href="#cb38-244" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> pplot_data) <span class="sc">+</span></span>
<span id="cb38-245"><a href="#cb38-245" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(x,qx), <span class="at">shape =</span> <span class="st">"o"</span>, <span class="at">alpha =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb38-246"><a href="#cb38-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(qx,qx)) <span class="sc">+</span></span>
<span id="cb38-247"><a href="#cb38-247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotation_logticks</span>(<span class="at">sides=</span><span class="st">"b"</span>) <span class="sc">+</span></span>
<span id="cb38-248"><a href="#cb38-248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_log10</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">50</span>),</span>
<span id="cb38-249"><a href="#cb38-249" aria-hidden="true" tabindex="-1"></a>                  <span class="at">limits=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="dv">50</span>),</span>
<span id="cb38-250"><a href="#cb38-250" aria-hidden="true" tabindex="-1"></a>                  <span class="at">minor_breaks=</span><span class="fu">c</span>(<span class="fl">0.2</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">20</span>) ) <span class="sc">+</span></span>
<span id="cb38-251"><a href="#cb38-251" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_log10</span>(<span class="at">breaks=</span>exp_quants,</span>
<span id="cb38-252"><a href="#cb38-252" aria-hidden="true" tabindex="-1"></a>                  <span class="at">labels=</span>probs,</span>
<span id="cb38-253"><a href="#cb38-253" aria-hidden="true" tabindex="-1"></a>                  <span class="at">limits=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="dv">50</span>),</span>
<span id="cb38-254"><a href="#cb38-254" aria-hidden="true" tabindex="-1"></a>                  <span class="at">minor_breaks=</span><span class="cn">NULL</span>) <span class="sc">+</span></span>
<span id="cb38-255"><a href="#cb38-255" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>() <span class="sc">+</span></span>
<span id="cb38-256"><a href="#cb38-256" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Sample log probability plot</span><span class="sc">\n</span><span class="st">Using simulated data"</span>,</span>
<span id="cb38-257"><a href="#cb38-257" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Concentration (native scale units)"</span>,</span>
<span id="cb38-258"><a href="#cb38-258" aria-hidden="true" tabindex="-1"></a>         <span class="at">y=</span> <span class="st">"% of data less than"</span>) <span class="sc">+</span></span>
<span id="cb38-259"><a href="#cb38-259" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb38-260"><a href="#cb38-260" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb38-261"><a href="#cb38-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-262"><a href="#cb38-262" aria-hidden="true" tabindex="-1"></a><span class="co">#-----qqplot in baseR----</span></span>
<span id="cb38-263"><a href="#cb38-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-264"><a href="#cb38-264" aria-hidden="true" tabindex="-1"></a><span class="co"># apparently qqnorm works fine in the presence of missing data:</span></span>
<span id="cb38-265"><a href="#cb38-265" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(DEMS<span class="sc">$</span>ecdata)</span>
<span id="cb38-266"><a href="#cb38-266" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(DEMS<span class="sc">$</span>ecdata, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb38-267"><a href="#cb38-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-268"><a href="#cb38-268" aria-hidden="true" tabindex="-1"></a><span class="co"># now repeat using the DEMSu subset of data since they should be closer to</span></span>
<span id="cb38-269"><a href="#cb38-269" aria-hidden="true" tabindex="-1"></a><span class="co"># normal</span></span>
<span id="cb38-270"><a href="#cb38-270" aria-hidden="true" tabindex="-1"></a><span class="fu">qqnorm</span>(DEMSu<span class="sc">$</span>ecdata)</span>
<span id="cb38-271"><a href="#cb38-271" aria-hidden="true" tabindex="-1"></a><span class="fu">qqline</span>(DEMSu<span class="sc">$</span>ecdata, <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb38-272"><a href="#cb38-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-273"><a href="#cb38-273" aria-hidden="true" tabindex="-1"></a><span class="co">#-----session information----</span></span>
<span id="cb38-274"><a href="#cb38-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-275"><a href="#cb38-275" aria-hidden="true" tabindex="-1"></a><span class="co"># print R session information</span></span>
<span id="cb38-276"><a href="#cb38-276" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb38-277"><a href="#cb38-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-278"><a href="#cb38-278" aria-hidden="true" tabindex="-1"></a><span class="co">#-----code appendix----</span></span>
<span id="cb38-279"><a href="#cb38-279" aria-hidden="true" tabindex="-1"></a><span class="co">#-----functions----</span></span>
<span id="cb38-280"><a href="#cb38-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-281"><a href="#cb38-281" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the names of all functions defined in the .Rmd</span></span>
<span id="cb38-282"><a href="#cb38-282" aria-hidden="true" tabindex="-1"></a><span class="co"># (e.g. loaded in the environment)</span></span>
<span id="cb38-283"><a href="#cb38-283" aria-hidden="true" tabindex="-1"></a><span class="fu">lsf.str</span>()</span>
<span id="cb38-284"><a href="#cb38-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-285"><a href="#cb38-285" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the definitions of all functions loaded into the current environment  </span></span>
<span id="cb38-286"><a href="#cb38-286" aria-hidden="true" tabindex="-1"></a><span class="fu">lsf.str</span>() <span class="sc">%&gt;%</span> <span class="fu">set_names</span>() <span class="sc">%&gt;%</span> <span class="fu">map</span>(get, .GlobalEnv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----functions----</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the names of all functions defined in the .Rmd</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co"># (e.g. loaded in the environment)</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lsf.str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>download_and_read_file : function (data_url, output_file_path)  
has_annotations : function (input)  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the definitions of all functions loaded into the current environment  </span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lsf.str</span>() <span class="sc">%&gt;%</span> <span class="fu">set_names</span>() <span class="sc">%&gt;%</span> <span class="fu">map</span>(get, .GlobalEnv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$download_and_read_file
function (data_url, output_file_path) 
{
    if (!file.exists(output_file_path)) {
        download.file(data_url, destfile = output_file_path, 
            method = "auto")
        message("File downloaded successfully.")
    }
    else {
        message("File already exists in the directory.")
    }
    file_ext &lt;- tolower(tools::file_ext(output_file_path))
    message("Reading in file.")
    if (file_ext == "csv") {
        data &lt;- read.csv(output_file_path)
    }
    else if (file_ext %in% c("rds", "rda")) {
        data &lt;- readRDS(output_file_path)
    }
    else {
        stop(paste("Unsupported file type:", file_ext, ". Please handle manually."))
    }
    return(data)
}

$has_annotations
function (input) 
{
    inputLines &lt;- readLines(input)
    chunkStarts &lt;- grep(knitr::all_patterns$md$chunk.begin, inputLines)
    chunkEnds &lt;- grep(knitr::all_patterns$md$chunk.end, inputLines)
    annotations &lt;- grep(".*\\Q#\\E\\s*&lt;[0-9]+&gt;\\s*", inputLines)
    hasAnnotations &lt;- FALSE
    if (length(chunkStarts) &gt; 0 &amp;&amp; length(annotations) &gt; 0) {
        lastLine &lt;- max(max(chunkEnds), max(chunkStarts), max(annotations))
        chunkMap &lt;- rep(FALSE, lastLine)
        for (x in 1:length(chunkStarts)) {
            start &lt;- chunkStarts[x]
            end &lt;- chunkEnds[x]
            for (y in start:end) {
                if (y &gt; start &amp;&amp; y &lt; end) {
                  chunkMap[y] = TRUE
                }
            }
        }
        for (a in annotations) {
            if (chunkMap[a] == TRUE) {
                hasAnnotations &lt;- TRUE
                break
            }
        }
    }
    hasAnnotations
}</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>